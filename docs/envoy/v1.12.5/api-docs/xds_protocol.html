

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xDS REST and gRPC protocol &mdash; envoy tag-v1.12.5 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FAQ" href="../faq/overview.html" />
    <link rel="prev" title="ValueMatcher" href="../api-v2/type/matcher/value.proto.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> envoy
          

          
          </a>

          
            
            
              <div class="version">
                tag-v1.12.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../api/api.html">API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../api-v2/api.html">v2 API reference</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">xDS REST and gRPC protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#filesystem-subscriptions">Filesystem subscriptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#streaming-grpc-subscriptions">Streaming gRPC subscriptions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#singleton-resource-type-discovery">Singleton resource type discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resource-update">Resource Update</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resource-warming">Resource warming</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aggregated-discovery-service">Aggregated Discovery Service</a></li>
<li class="toctree-l4"><a class="reference internal" href="#incremental-xds">Incremental xDS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#rest-json-polling-subscriptions">REST-JSON polling subscriptions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../api/api.html">API</a> &raquo;</li>
        
      <li>xDS REST and gRPC protocol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api-docs/xds_protocol.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="xds-rest-and-grpc-protocol">
<span id="xds-protocol"></span><h1>xDS REST and gRPC protocol<a class="headerlink" href="#xds-rest-and-grpc-protocol" title="Permalink to this headline">¶</a></h1>
<p>Envoy discovers its various dynamic resources via the filesystem or by
querying one or more management servers. Collectively, these discovery
services and their corresponding APIs are referred to as <em>xDS</em>.
Resources are requested via <em>subscriptions</em>, by specifying a filesystem
path to watch, initiating gRPC streams or polling a REST-JSON URL. The
latter two methods involve sending requests with a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a>
proto payload. Resources are delivered in a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>
proto payload in all methods. We discuss each type of subscription
below.</p>
<div class="section" id="filesystem-subscriptions">
<h2>Filesystem subscriptions<a class="headerlink" href="#filesystem-subscriptions" title="Permalink to this headline">¶</a></h2>
<p>The simplest approach to delivering dynamic configuration is to place it
at a well known path specified in the <a class="reference internal" href="../api-v2/api/v2/core/config_source.proto.html#envoy-api-msg-core-configsource"><span class="std std-ref">ConfigSource</span></a>.
Envoy will use <cite>inotify</cite> (<cite>kqueue</cite> on macOS) to monitor the file for
changes and parse the
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> proto in the file on update.
Binary protobufs, JSON, YAML and proto text are supported formats for
the
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>.</p>
<p>There is no mechanism available for filesystem subscriptions to ACK/NACK
updates beyond stats counters and logs. The last valid configuration for
an xDS API will continue to apply if an configuration update rejection
occurs.</p>
</div>
<div class="section" id="streaming-grpc-subscriptions">
<span id="xds-protocol-streaming-grpc-subscriptions"></span><h2>Streaming gRPC subscriptions<a class="headerlink" href="#streaming-grpc-subscriptions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="singleton-resource-type-discovery">
<h3>Singleton resource type discovery<a class="headerlink" href="#singleton-resource-type-discovery" title="Permalink to this headline">¶</a></h3>
<p>A gRPC
<a class="reference internal" href="../api-v2/api/v2/core/config_source.proto.html#envoy-api-msg-core-apiconfigsource"><span class="std std-ref">ApiConfigSource</span></a>
can be specified independently for each xDS API, pointing at an upstream
cluster corresponding to a management server. This will initiate an
independent bidirectional gRPC stream for each xDS resource type,
potentially to distinct management servers. API delivery is eventually
consistent. See <a class="reference internal" href="#xds-protocol-ads"><span class="std std-ref">Aggregated Discovery Service</span></a>
below for situations in which explicit control of sequencing is required.</p>
<div class="section" id="type-urls">
<h4>Type URLs<a class="headerlink" href="#type-urls" title="Permalink to this headline">¶</a></h4>
<p>Each xDS API is concerned with resources of a given type. There is a 1:1
correspondence between an xDS API and a resource type. That is:</p>
<ul class="simple">
<li><p>LDS: <a class="reference internal" href="../api-v2/api/v2/lds.proto.html#envoy-api-msg-listener"><span class="std std-ref">envoy.api.v2.Listener</span></a></p></li>
<li><p>RDS: <a class="reference internal" href="../api-v2/api/v2/rds.proto.html#envoy-api-msg-routeconfiguration"><span class="std std-ref">envoy.api.v2.RouteConfiguration</span></a></p></li>
<li><p>VHDS: <a class="reference internal" href="../api-v2/api/v2/rds.proto.html#envoy-api-msg-routeconfiguration"><span class="std std-ref">envoy.api.v2.Vhds</span></a></p></li>
<li><p>CDS: <a class="reference internal" href="../api-v2/api/v2/cds.proto.html#envoy-api-msg-cluster"><span class="std std-ref">envoy.api.v2.Cluster</span></a></p></li>
<li><p>EDS: <a class="reference internal" href="../api-v2/api/v2/eds.proto.html#envoy-api-msg-clusterloadassignment"><span class="std std-ref">envoy.api.v2.ClusterLoadAssignment</span></a></p></li>
<li><p>SDS: <a class="reference internal" href="../api-v2/api/v2/auth/cert.proto.html#envoy-api-msg-auth-secret"><span class="std std-ref">envoy.api.v2.Auth.Secret</span></a></p></li>
<li><p>RTDS: <a class="reference internal" href="../api-v2/service/discovery/v2/rtds.proto.html#envoy-api-msg-service-discovery-v2-runtime"><span class="std std-ref">envoy.service.discovery.v2.Runtime</span></a></p></li>
</ul>
<p>The concept of <a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto3#any">type URLs</a> appears below, and takes the form
<cite>type.googleapis.com/&lt;resource type&gt;</cite>, e.g.
<cite>type.googleapis.com/envoy.api.v2.Cluster</cite> for CDS. In various
requests from Envoy and responses by the management server, the resource
type URL is stated.</p>
</div>
<div class="section" id="ack-nack-and-versioning">
<h4>ACK/NACK and versioning<a class="headerlink" href="#ack-nack-and-versioning" title="Permalink to this headline">¶</a></h4>
<p>Each stream begins with a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> from Envoy, specifying
the list of resources to subscribe to, the type URL corresponding to the
subscribed resources, the node identifier and an empty <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-version-info"><span class="std std-ref">version_info</span></a>.
An example EDS request might be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version_info</span><span class="p">:</span>
<span class="nt">node</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> id</span><span class="p">:</span> <span class="nv">envoy</span> <span class="p p-Indicator">}</span>
<span class="nt">resource_names</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">foo</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
<span class="nt">type_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.api.v2.ClusterLoadAssignment</span>
<span class="nt">response_nonce</span><span class="p">:</span>
</pre></div>
</div>
<p>The management server may reply either immediately or when the requested
resources are available with a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>, e.g.:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version_info</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">X</span>
<span class="nt">resources</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">foo ClusterLoadAssignment proto encoding</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bar ClusterLoadAssignment proto encoding</span>
<span class="nt">type_url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.api.v2.ClusterLoadAssignment</span>
<span class="nt">nonce</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">A</span>
</pre></div>
</div>
<p>After processing the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>, Envoy will send a new
request on the stream, specifying the last version successfully applied
and the nonce provided by the management server. If the update was
successfully applied, the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryresponse-version-info"><span class="std std-ref">version_info</span></a> will be <strong>X</strong>, as indicated
in the sequence diagram:</p>
<div class="figure align-default">
<img alt="Version update after ACK" src="../_images/simple-ack.svg" /></div>
<p>In this sequence diagram, and below, the following format is used to abbreviate messages:</p>
<ul class="simple">
<li><p><em>DiscoveryRequest</em>: (V=version_info,R=resource_names,N=response_nonce,T=type_url)</p></li>
<li><p><em>DiscoveryResponse</em>: (V=version_info,R=resources,N=nonce,T=type_url)</p></li>
</ul>
<p>The version provides Envoy and the management server a shared notion of
the currently applied configuration, as well as a mechanism to ACK/NACK
configuration updates. If Envoy had instead rejected configuration
update <strong>X</strong>, it would reply with <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-error-detail"><span class="std std-ref">error_detail</span></a>
populated and its previous version, which in this case was the empty
initial version. The <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-error-detail"><span class="std std-ref">error_detail</span></a> has more details around the exact
error message populated in the message field:</p>
<div class="figure align-default">
<img alt="No version update after NACK" src="../_images/simple-nack.svg" /></div>
<p>Later, an API update may succeed at a new version <strong>Y</strong>:</p>
<div class="figure align-default">
<img alt="ACK after NACK" src="../_images/later-ack.svg" /></div>
<p>Each stream has its own notion of versioning, there is no shared
versioning across resource types. When ADS is not used, even each
resource of a given resource type may have a distinct version, since the
Envoy API allows distinct EDS/RDS resources to point at different <a class="reference internal" href="../api-v2/api/v2/core/config_source.proto.html#envoy-api-msg-core-configsource"><span class="std std-ref">ConfigSources</span></a>.</p>
<p>Only the first request on a stream is guaranteed to carry the node identifier.
The subsequent discovery requests on the same stream may carry an empty node
identifier. This holds true regardless of the acceptance of the discovery
responses on the same stream. The node identifier should always be identical if
present more than once on the stream. It is sufficient to only check the first
message for the node identifier as a result.</p>
</div>
</div>
<div class="section" id="resource-update">
<span id="xds-protocol-resource-update"></span><h3>Resource Update<a class="headerlink" href="#resource-update" title="Permalink to this headline">¶</a></h3>
<div class="section" id="when-to-send-an-update">
<h4>When to send an update<a class="headerlink" href="#when-to-send-an-update" title="Permalink to this headline">¶</a></h4>
<p>The management server should only send updates to the Envoy client when
the resources in the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> have changed. Envoy replies
to any <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> with a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> containing the
ACK/NACK immediately after it has been either accepted or rejected. If
the management server provides the same set of resources rather than
waiting for a change to occur, it will cause Envoy and the management
server to spin and have a severe performance impact.</p>
<p>Within a stream, new <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequests</span></a> supersede any prior
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequests</span></a> having the same resource type. This means that
the management server only needs to respond to the latest
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> on each stream for any given resource type.</p>
</div>
<div class="section" id="resource-hints">
<h4>Resource hints<a class="headerlink" href="#resource-hints" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> specified in the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> are a hint.
Some resource types, e.g. <cite>Clusters</cite> and <cite>Listeners</cite> may
specify an empty <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> list, since a client such as Envoy is interested in
learning about all the <a class="reference internal" href="../api-v2/api/v2/cds.proto.html#envoy-api-msg-cluster"><span class="std std-ref">Clusters (CDS)</span></a> and <a class="reference internal" href="../api-v2/api/v2/lds.proto.html#envoy-api-msg-listener"><span class="std std-ref">Listeners (LDS)</span></a>
that the management server(s) know about corresponding to its node
identification. Other resource types, e.g. <a class="reference internal" href="../api-v2/api/v2/rds.proto.html#envoy-api-msg-routeconfiguration"><span class="std std-ref">RouteConfiguration (RDS)</span></a>
and <a class="reference internal" href="../api-v2/api/v2/eds.proto.html#envoy-api-msg-clusterloadassignment"><span class="std std-ref">ClusterLoadAssignment (EDS)</span></a>, follow from earlier
CDS/LDS updates and Envoy is able to explicitly enumerate these
resources.</p>
<p>Envoy will always set the LDS/CDS resource hints to empty and it is expected that the management
server will provide the complete state of the LDS/CDS resources in each response. An absent
<cite>Listener</cite> or <cite>Cluster</cite> will be deleted. Other xDS clients may specify explicit LDS/CDS resources as
resource hints, for example if they only have a singleton listener and already know its name from
some out-of-band configuration.</p>
<p>For EDS/RDS, the management server does not need to supply every
requested resource and may also supply additional, unrequested
resources. <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> is only a hint. Envoy will silently ignore
any superfluous resources. When a requested resource is missing in a RDS
or EDS update, Envoy will retain the last known value for this resource
except in the case where the <cite>Cluster</cite> or <cite>Listener</cite> is being
warmed. See <a class="reference internal" href="#xds-protocol-resource-warming"><span class="std std-ref">Resource Warming</span></a> section below on
the expectations during warming. The management server may be able to
infer all the required EDS/RDS resources from the <a class="reference internal" href="../api-v2/api/v2/core/base.proto.html#envoy-api-msg-core-node"><span class="std std-ref">node</span></a>
identification in the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a>, in which case this hint may
be discarded. An empty EDS/RDS <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> is effectively a
nop from the perspective of the respective resources in the Envoy.</p>
<p>When a <cite>Listener</cite> or <cite>Cluster</cite> is deleted, its corresponding EDS and
RDS resources are also deleted inside the Envoy instance. In order for
EDS resources to be known or tracked by Envoy, there must exist an
applied <cite>Cluster</cite> definition (e.g. sourced via CDS). A similar
relationship exists between RDS and <cite>Listeners</cite> (e.g. sourced via
LDS).</p>
<p>For EDS/RDS, Envoy may either generate a distinct stream for each
resource of a given type (e.g. if each <a class="reference internal" href="../api-v2/api/v2/core/config_source.proto.html#envoy-api-msg-core-configsource"><span class="std std-ref">ConfigSource</span></a> has its own
distinct upstream cluster for a management server), or may combine
together multiple resource requests for a given resource type when they
are destined for the same management server. While this is left to
implementation specifics, management servers should be capable of
handling one or more <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> for a given resource type in
each request. Both sequence diagrams below are valid for fetching two
EDS resources <cite>{foo, bar}</cite>:</p>
<p><img alt="Multiple EDS requests on the same stream" src="../_images/eds-same-stream.svg" /> <img alt="Multiple EDS requests on distinct streams" src="../_images/eds-distinct-stream.svg" /></p>
</div>
<div class="section" id="resource-updates">
<h4>Resource updates<a class="headerlink" href="#resource-updates" title="Permalink to this headline">¶</a></h4>
<p>As discussed above, Envoy may update the list of <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> it
presents to the management server in each <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> that
ACK/NACKs a specific <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>. In addition, Envoy may later
issue additional <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequests</span></a> at a given <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-version-info"><span class="std std-ref">version_info</span></a> to
update the management server with new resource hints. For example, if
Envoy is at EDS version <strong>X</strong> and knows only about cluster <code class="docutils literal notranslate"><span class="pre">foo</span></code>, but
then receives a CDS update and learns about <code class="docutils literal notranslate"><span class="pre">bar</span></code> in addition, it may
issue an additional <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> for <strong>X</strong> with <cite>{foo,bar}</cite> as
<cite>resource_names</cite>.</p>
<div class="figure align-default">
<img alt="CDS response leads to EDS resource hint update" src="../_images/cds-eds-resources.svg" /></div>
<p>There is a race condition that may arise here; if after a resource hint
update is issued by Envoy at <strong>X</strong>, but before the management server
processes the update it replies with a new version <strong>Y</strong>, the resource
hint update may be interpreted as a rejection of <strong>Y</strong> by presenting an
<strong>X</strong> <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryresponse-version-info"><span class="std std-ref">version_info</span></a>. To avoid this, the management server provides a
<code class="docutils literal notranslate"><span class="pre">nonce</span></code> that Envoy uses to indicate the specific <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>
each <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> corresponds to:</p>
<div class="figure align-default">
<img alt="EDS update race motivates nonces" src="../_images/update-race.svg" /></div>
<p>The management server should not send a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> for any
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> that has a stale nonce. A nonce becomes stale
following a newer nonce being presented to Envoy in a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>. A management server does not need to send an
update until it determines a new version is available. Earlier requests
at a version then also become stale. It may process multiple
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequests</span></a> at a version until a new version is ready.</p>
<div class="figure align-default">
<img alt="Requests become stale" src="../_images/stale-requests.svg" /></div>
<p>An implication of the above resource update sequencing is that Envoy
does not expect a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> for every <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequests</span></a>
it issues.</p>
</div>
</div>
<div class="section" id="resource-warming">
<span id="xds-protocol-resource-warming"></span><h3>Resource warming<a class="headerlink" href="#resource-warming" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../intro/arch_overview/upstream/cluster_manager.html#arch-overview-cluster-warming"><span class="std std-ref">Clusters</span></a> and
<a class="reference internal" href="../configuration/listeners/lds.html#config-listeners-lds"><span class="std std-ref">Listeners</span></a>
go through warming before they can serve requests. This process
happens both during <a class="reference internal" href="../intro/arch_overview/operations/init.html#arch-overview-initialization"><span class="std std-ref">Envoy initialization</span></a>
and when the <cite>Cluster</cite> or <cite>Listener</cite> is updated. Warming of
<cite>Cluster</cite> is completed only when a <cite>ClusterLoadAssignment</cite> response
is supplied by management server. Similarly, warming of <cite>Listener</cite> is
completed only when a <cite>RouteConfiguration</cite> is supplied by management
server if the listener refers to an RDS configuration. Management server
is expected to provide the EDS/RDS updates during warming. If management
server does not provide EDS/RDS responses, Envoy will not initialize
itself during the initialization phase and the updates sent via CDS/LDS
will not take effect until EDS/RDS responses are supplied.</p>
<div class="section" id="eventual-consistency-considerations">
<span id="xds-protocol-eventual-consistency-considerations"></span><h4>Eventual consistency considerations<a class="headerlink" href="#eventual-consistency-considerations" title="Permalink to this headline">¶</a></h4>
<p>Since Envoy’s xDS APIs are eventually consistent, traffic may drop
briefly during updates. For example, if only cluster <strong>X</strong> is known via
CDS/EDS, a <cite>RouteConfiguration</cite> references cluster <strong>X</strong> and is then
adjusted to cluster <strong>Y</strong> just before the CDS/EDS update providing
<strong>Y</strong>, traffic will be blackholed until <strong>Y</strong> is known about by the
Envoy instance.</p>
<p>For some applications, a temporary drop of traffic is acceptable,
retries at the client or by other Envoy sidecars will hide this drop.
For other scenarios where drop can’t be tolerated, traffic drop could
have been avoided by providing a CDS/EDS update with both <strong>X</strong> and
<strong>Y</strong>, then the RDS update repointing from <strong>X</strong> to <strong>Y</strong> and then a
CDS/EDS update dropping <strong>X</strong>.</p>
<p>In general, to avoid traffic drop, sequencing of updates should follow a
make before break model, wherein:</p>
<ul class="simple">
<li><p>CDS updates (if any) must always be pushed first.</p></li>
<li><p>EDS updates (if any) must arrive after CDS updates for the respective clusters.</p></li>
<li><p>LDS updates must arrive after corresponding CDS/EDS updates.</p></li>
<li><p>RDS updates related to the newly added listeners must arrive after CDS/EDS/LDS updates.</p></li>
<li><p>VHDS updates (if any) related to the newly added RouteConfigurations must arrive after RDS updates.</p></li>
<li><p>Stale CDS clusters and related EDS endpoints (ones no longer being referenced) can then be removed.</p></li>
</ul>
<p>xDS updates can be pushed independently if no new
clusters/routes/listeners are added or if it’s acceptable to temporarily
drop traffic during updates. Note that in case of LDS updates, the
listeners will be warmed before they receive traffic, i.e. the dependent
routes are fetched through RDS if configured. Clusters are warmed when
adding/removing/updating clusters. On the other hand, routes are not
warmed, i.e., the management plane must ensure that clusters referenced
by a route are in place, before pushing the updates for a route.</p>
</div>
</div>
<div class="section" id="aggregated-discovery-service">
<span id="xds-protocol-ads"></span><h3>Aggregated Discovery Service<a class="headerlink" href="#aggregated-discovery-service" title="Permalink to this headline">¶</a></h3>
<p>It’s challenging to provide the above guarantees on sequencing to avoid
traffic drop when management servers are distributed. ADS allow a single
management server, via a single gRPC stream, to deliver all API updates.
This provides the ability to carefully sequence updates to avoid traffic
drop. With ADS, a single stream is used with multiple independent
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a>/<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> sequences multiplexed via the
type URL. For any given type URL, the above sequencing of
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> and <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> messages applies. An
example update sequence might look like:</p>
<div class="figure align-default">
<img alt="EDS/CDS multiplexed on an ADS stream" src="../_images/ads.svg" /></div>
<p>A single ADS stream is available per Envoy instance.</p>
<p>An example minimal <code class="docutils literal notranslate"><span class="pre">bootstrap.yaml</span></code> fragment for ADS configuration is:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">node</span><span class="p">:</span>
  <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;node identifier&gt;</span>
<span class="nt">dynamic_resources</span><span class="p">:</span>
  <span class="nt">cds_config</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">ads</span><span class="p">:</span> <span class="p p-Indicator">{}}</span>
  <span class="nt">lds_config</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt">ads</span><span class="p">:</span> <span class="p p-Indicator">{}}</span>
  <span class="nt">ads_config</span><span class="p">:</span>
    <span class="nt">api_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">GRPC</span>
    <span class="nt">grpc_services</span><span class="p">:</span>
      <span class="nt">envoy_grpc</span><span class="p">:</span>
        <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ads_cluster</span>
<span class="nt">static_resources</span><span class="p">:</span>
  <span class="nt">clusters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ads_cluster</span>
    <span class="nt">connect_timeout</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> seconds</span><span class="p">:</span> <span class="nv">5</span> <span class="p p-Indicator">}</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STATIC</span>
    <span class="nt">hosts</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">socket_address</span><span class="p">:</span>
        <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;ADS management server IP address&gt;</span>
        <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;ADS management server port&gt;</span>
    <span class="nt">lb_policy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
    <span class="nt">http2_protocol_options</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
    <span class="nt">upstream_connection_options</span><span class="p">:</span>
      <span class="c1"># configure a TCP keep-alive to detect and reconnect to the admin</span>
      <span class="c1"># server in the event of a TCP socket disconnection</span>
      <span class="nt">tcp_keepalive</span><span class="p">:</span>
        <span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="nt">admin</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
</div>
<div class="section" id="incremental-xds">
<span id="xds-protocol-delta"></span><h3>Incremental xDS<a class="headerlink" href="#incremental-xds" title="Permalink to this headline">¶</a></h3>
<p>Incremental xDS is a separate xDS endpoint that:</p>
<ul class="simple">
<li><p>Allows the protocol to communicate on the wire in terms of
resource/resource name deltas (“Delta xDS”). This supports the goal
of scalability of xDS resources. Rather than deliver all 100k
clusters when a single cluster is modified, the management server
only needs to deliver the single cluster that changed.</p></li>
<li><p>Allows the Envoy to on-demand / lazily request additional resources.
For example, requesting a cluster only when a request for that
cluster arrives.</p></li>
</ul>
<p>An Incremental xDS session is always in the context of a gRPC
bidirectional stream. This allows the xDS server to keep track of the
state of xDS clients connected to it. There is no REST version of
Incremental xDS yet.</p>
<p>In the delta xDS wire protocol, the nonce field is required and used to
pair a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryresponse"><span class="std std-ref">DeltaDiscoveryResponse</span></a>
to a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a>
ACK or NACK. Optionally, a response message level <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryresponse-system-version-info"><span class="std std-ref">system_version_info</span></a>
is present for debugging purposes only.</p>
<p><a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a> can be sent in the following situations:</p>
<ul class="simple">
<li><p>Initial message in a xDS bidirectional gRPC stream.</p></li>
<li><p>As an ACK or NACK response to a previous <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryresponse"><span class="std std-ref">DeltaDiscoveryResponse</span></a>. In this case the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-response-nonce"><span class="std std-ref">response_nonce</span></a> is set to the nonce value in the Response. ACK or NACK is determined by the absence or presence of <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-error-detail"><span class="std std-ref">error_detail</span></a>.</p></li>
<li><p>Spontaneous <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequests</span></a> from the client. This can be done to dynamically add or remove elements from the tracked <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-resource-names"><span class="std std-ref">resource_names</span></a> set. In this case <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-discoveryrequest-response-nonce"><span class="std std-ref">response_nonce</span></a> must be omitted.</p></li>
</ul>
<p>In this first example the client connects and receives a first update
that it ACKs. The second update fails and the client NACKs the update.
Later the xDS client spontaneously requests the “wc” resource.</p>
<div class="figure align-default">
<img alt="Incremental session example" src="../_images/incremental.svg" /></div>
<p>On reconnect the Incremental xDS client may tell the server of its known
resources to avoid resending them over the network. Because no state is
assumed to be preserved from the previous stream, the reconnecting
client must provide the server with all resource names it is interested
in.</p>
<div class="figure align-default">
<img alt="Incremental reconnect example" src="../_images/incremental-reconnect.svg" /></div>
<div class="section" id="resource-names">
<h4>Resource names<a class="headerlink" href="#resource-names" title="Permalink to this headline">¶</a></h4>
<p>Resources are identified by a resource name or an alias. Aliases of a
resource, if present, can be identified by the alias field in the
resource of a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryresponse"><span class="std std-ref">DeltaDiscoveryResponse</span></a>. The resource name will be
returned in the name field in the resource of a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryresponse"><span class="std std-ref">DeltaDiscoveryResponse</span></a>.</p>
</div>
<div class="section" id="subscribing-to-resources">
<h4>Subscribing to Resources<a class="headerlink" href="#subscribing-to-resources" title="Permalink to this headline">¶</a></h4>
<p>The client can send either an alias or the name of a resource in the
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryrequest-resource-names-subscribe"><span class="std std-ref">resource_names_subscribe</span></a> field of a <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a> in
order to subscribe to a resource. Both the names and aliases of
resources should be checked in order to determine whether the entity in
question has been subscribed to.</p>
<p>A <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryrequest-resource-names-subscribe"><span class="std std-ref">resource_names_subscribe</span></a> field may contain resource names that the
server believes the client is already subscribed to, and furthermore has
the most recent versions of. However, the server <em>must</em> still provide
those resources in the response; due to implementation details hidden
from the server, the client may have “forgotten” those resources despite
apparently remaining subscribed.</p>
</div>
<div class="section" id="unsubscribing-from-resources">
<span id="xds-protocol-unsubscribe"></span><h4>Unsubscribing from Resources<a class="headerlink" href="#unsubscribing-from-resources" title="Permalink to this headline">¶</a></h4>
<p>When a client loses interest in some resources, it will indicate that
with the <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryrequest-resource-names-unsubscribe"><span class="std std-ref">resource_names_unsubscribe</span></a> field of a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-deltadiscoveryrequest"><span class="std std-ref">DeltaDiscoveryRequest</span></a>. As with <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryrequest-resource-names-subscribe"><span class="std std-ref">resource_names_subscribe</span></a>, these
may be resource names or aliases.</p>
<p>A <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-field-deltadiscoveryrequest-resource-names-unsubscribe"><span class="std std-ref">resource_names_unsubscribe</span></a> field may contain superfluous resource
names, which the server thought the client was already not subscribed
to. The server must cleanly process such a request; it can simply ignore
these phantom unsubscriptions.</p>
</div>
</div>
</div>
<div class="section" id="rest-json-polling-subscriptions">
<h2>REST-JSON polling subscriptions<a class="headerlink" href="#rest-json-polling-subscriptions" title="Permalink to this headline">¶</a></h2>
<p>Synchronous (long) polling via REST endpoints is also available for the
xDS singleton APIs. The above sequencing of messages is similar, except
no persistent stream is maintained to the management server. It is
expected that there is only a single outstanding request at any point in
time, and as a result the response nonce is optional in REST-JSON. The
<a class="reference external" href="https://developers.google.com/protocol-buffers/docs/proto3#json">JSON canonical transform of
proto3</a>
is used to encode <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryrequest"><span class="std std-ref">DiscoveryRequest</span></a> and <a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a>
messages. ADS is not available for REST-JSON polling.</p>
<p>When the poll period is set to a small value, with the intention of long
polling, then there is also a requirement to avoid sending a
<a class="reference internal" href="../api-v2/api/v2/discovery.proto.html#envoy-api-msg-discoveryresponse"><span class="std std-ref">DiscoveryResponse</span></a> unless a change to the underlying resources has
occurred via a <a class="reference internal" href="#xds-protocol-resource-update"><span class="std std-ref">resource update</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../faq/overview.html" class="btn btn-neutral float-right" title="FAQ" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../api-v2/type/matcher/value.proto.html" class="btn btn-neutral float-left" title="ValueMatcher" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>