

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Priority levels &mdash; envoy 1.18.0-dev-6936ea documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Degraded endpoints" href="degraded.html" />
    <link rel="prev" title="Supported load balancers" href="load_balancers.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.18.0-dev-6936ea
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../upstream.html">Upstream clusters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="../service_discovery.html">Service discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dns_resolution.html">DNS Resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="../health_checking.html">Health checking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="load_balancing.html">Load Balancing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../aggregate_cluster.html">Aggregate Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../outlier.html">Outlier detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="../circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../load_reporting_service.html">Load Reporting Service (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../getting_help.html">Getting help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="../upstream.html">Upstream clusters</a> &raquo;</li>
        
          <li><a href="load_balancing.html">Load Balancing</a> &raquo;</li>
        
      <li>Priority levels</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/intro/arch_overview/upstream/load_balancing/priority.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="priority-levels">
<span id="arch-overview-load-balancing-priority-levels"></span><h1>Priority levels<a class="headerlink" href="#priority-levels" title="Permalink to this headline">¶</a></h1>
<p>During load balancing, Envoy will generally only consider hosts configured at the highest priority
level. For each EDS <a class="reference internal" href="../../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-msg-config-endpoint-v3-localitylbendpoints"><span class="std std-ref">LocalityLbEndpoints</span></a> an optional
priority may also be specified. When endpoints at the highest priority level (P=0) are healthy, all
traffic will land on endpoints in that priority level. As endpoints for the highest priority level
become unhealthy, traffic will begin to trickle to lower priority levels.</p>
<p>The system can be overprovisioned with a configurable
<a class="reference internal" href="overprovisioning.html#arch-overview-load-balancing-overprovisioning-factor"><span class="std std-ref">overprovisioning factor</span></a>, which
currently defaults to 1.4 (this document will assume this value). If 80% of the endpoints in a
priority level are healthy, that level is still considered fully healthy because 80*1.4 &gt; 100.
So, level 0 endpoints will continue to receive all traffic until less than ~71.4% of them are
healthy.</p>
<p>The priority level logic works with integer health scores. The health score of a level is
(percent of healthy hosts in the level) * (overprovisioning factor), capped at 100%. P=0
endpoints receive (level 0’s health score) percent of the traffic, with the rest flowing
to P=1 (assuming P=1 is 100% healthy - more on that later). For instance, when 50% of P=0
endpoints are healthy, they will receive 50 * 1.4 = 70% of the traffic.
The integer percents of traffic that each priority level receives are collectively called the
system’s “priority load”. More examples (with 2 priority levels, P=1 100% healthy):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 46%" />
<col style="width: 26%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>P=0 healthy endpoints</p></th>
<th class="head"><p>Traffic to P=0</p></th>
<th class="head"><p>Traffic to P=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-even"><td><p>71%</p></td>
<td><p>99%</p></td>
<td><p>1%</p></td>
</tr>
<tr class="row-odd"><td><p>50%</p></td>
<td><p>70%</p></td>
<td><p>30%</p></td>
</tr>
<tr class="row-even"><td><p>25%</p></td>
<td><p>35%</p></td>
<td><p>65%</p></td>
</tr>
<tr class="row-odd"><td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
</tr>
</tbody>
</table>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>In order for the load distribution algorithm and normalized total health calculation to work
properly, each priority level must be able to handle (100% * overprovision factor) of the
traffic: Envoy assumes a 100% healthy P=1 can take over entirely for an unhealthy P=0, etc.
If P=0 has 10 hosts but P=1 only has 2 hosts, that assumption probably will not hold.</p>
</div>
<p>The health score represents a level’s current ability to handle traffic, after factoring in how
overprovisioned the level originally was, and how many endpoints are currently unhealthy.
Therefore, if the sum across all levels’ health scores is &lt; 100, then Envoy believes there are not
enough healthy endpoints to fully handle the traffic. This sum is called the “normalized total
health.” When normalized total health drops below 100, traffic is distributed after normalizing
the levels’ health scores to that sub-100 total. E.g. healths of {20, 30} (yielding a normalized
total health of 50) would be normalized, and result in a priority load of {40%, 60%} of traffic.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 30%" />
<col style="width: 21%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>P=0 healthy endpoints</p></th>
<th class="head"><p>P=1 healthy endpoints</p></th>
<th class="head"><p>Traffic to  P=0</p></th>
<th class="head"><p>Traffic to P=1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>72%</p></td>
<td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-even"><td><p>71%</p></td>
<td><p>71%</p></td>
<td><p>99%</p></td>
<td><p>1%</p></td>
</tr>
<tr class="row-odd"><td><p>50%</p></td>
<td><p>50%</p></td>
<td><p>70%</p></td>
<td><p>30%</p></td>
</tr>
<tr class="row-even"><td><p>25%</p></td>
<td><p>100%</p></td>
<td><p>35%</p></td>
<td><p>65%</p></td>
</tr>
<tr class="row-odd"><td><p>25%</p></td>
<td><p>25%</p></td>
<td><p>50%</p></td>
<td><p>50%</p></td>
</tr>
</tbody>
</table>
<p>As more priorities are added, each level consumes load equal to its normalized effective health,
unless the healths of the levels above it sum to 100%, in which case it receives no load.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>P=0 healthy endpoints</p></th>
<th class="head"><p>P=1 healthy endpoints</p></th>
<th class="head"><p>P=2 healthy endpoints</p></th>
<th class="head"><p>Traffic to P=0</p></th>
<th class="head"><p>Traffic to P=1</p></th>
<th class="head"><p>Traffic to P=2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>72%</p></td>
<td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-even"><td><p>71%</p></td>
<td><p>71%</p></td>
<td><p>100%</p></td>
<td><p>99%</p></td>
<td><p>1%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>50%</p></td>
<td><p>50%</p></td>
<td><p>100%</p></td>
<td><p>70%</p></td>
<td><p>30%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-even"><td><p>25%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>35%</p></td>
<td><p>65%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>25%</p></td>
<td><p>25%</p></td>
<td><p>100%</p></td>
<td><p>35%</p></td>
<td><p>35%</p></td>
<td><p>30%</p></td>
</tr>
<tr class="row-even"><td><p>25%</p></td>
<td><p>25%</p></td>
<td><p>20%</p></td>
<td><p>36%</p></td>
<td><p>36%</p></td>
<td><p>28%</p></td>
</tr>
</tbody>
</table>
<p>To sum this up in pseudo algorithms:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">1.4</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">healthy_P_X_backends</span> <span class="o">/</span> <span class="n">total_P_X_backends</span><span class="p">)</span>
<span class="n">normalized_total_health</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">Σ</span><span class="p">(</span><span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">...</span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)))</span>
<span class="n">priority_load</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">)</span>
<span class="n">priority_load</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">Σ</span><span class="p">(</span><span class="n">priority_load</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">..</span><span class="n">priority_load</span><span class="p">(</span><span class="n">P_X</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                         <span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: This sectioned talked about healthy priorities, but this also extends to
<a class="reference internal" href="degraded.html#arch-overview-load-balancing-degraded"><span class="std std-ref">degraded priorities</span></a>.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="degraded.html" class="btn btn-neutral float-right" title="Degraded endpoints" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="load_balancers.html" class="btn btn-neutral float-left" title="Supported load balancers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2021, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>