

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Aggregate Cluster &mdash; envoy 1.15.0-dev-cef649 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Outlier detection" href="outlier.html" />
    <link rel="prev" title="Load Balancer Subsets" href="load_balancing/subsets.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.15.0-dev-cef649
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../intro.html">Introduction</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../what_is_envoy.html">What is Envoy</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../arch_overview.html">Architecture overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro/intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listeners/listeners_toc.html">Listeners</a></li>
<li class="toctree-l3"><a class="reference internal" href="../http/http.html">HTTP</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="upstream.html">Upstream clusters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="cluster_manager.html">Cluster manager</a></li>
<li class="toctree-l4"><a class="reference internal" href="service_discovery.html">Service discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_checking.html">Health checking</a></li>
<li class="toctree-l4"><a class="reference internal" href="connection_pooling.html">Connection pooling</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_balancing/load_balancing.html">Load Balancing</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Aggregate Cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="outlier.html">Outlier detection</a></li>
<li class="toctree-l4"><a class="reference internal" href="circuit_breaking.html">Circuit breaking</a></li>
<li class="toctree-l4"><a class="reference internal" href="upstream_filters.html">Upstream network filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="load_reporting_service.html">Load Reporting Service (LRS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../observability/observability.html">Observability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/security.html">Security</a></li>
<li class="toctree-l3"><a class="reference internal" href="../operations/operations.html">Operations &amp; configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_features/other_features.html">Other features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="../advanced/advanced.html">Advanced</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../life_of_a_request.html">Life of a Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deployment_types/deployment_types.html">Deployment types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting_help.html">Getting help</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../version_history.html">Version History</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../deprecated.html">Deprecated</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../intro.html">Introduction</a> &raquo;</li>
        
          <li><a href="../arch_overview.html">Architecture overview</a> &raquo;</li>
        
          <li><a href="upstream.html">Upstream clusters</a> &raquo;</li>
        
      <li>Aggregate Cluster</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/intro/arch_overview/upstream/aggregate_cluster.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="aggregate-cluster">
<span id="arch-overview-aggregate-cluster"></span><h1>Aggregate Cluster<a class="headerlink" href="#aggregate-cluster" title="Permalink to this headline">¶</a></h1>
<p>Aggregate cluster is used for failover between clusters with different configuration, e.g., from EDS
upstream cluster to STRICT_DNS upstream cluster, from cluster using ROUND_ROBIN load balancing
policy to cluster using MAGLEV, from cluster with 0.1s connection timeout to cluster with 1s
connection timeout, etc. Aggregate cluster loosely couples multiple clusters by referencing their
name in the <a class="reference internal" href="../../../api-v3/extensions/clusters/aggregate/v3/cluster.proto.html#envoy-v3-api-msg-extensions-clusters-aggregate-v3-clusterconfig"><span class="std std-ref">configuration</span></a>. The
fallback priority is defined implicitly by the ordering in the <a class="reference internal" href="../../../api-v3/extensions/clusters/aggregate/v3/cluster.proto.html#envoy-v3-api-field-extensions-clusters-aggregate-v3-clusterconfig-clusters"><span class="std std-ref">clusters list</span></a>.
Aggregate cluster uses tiered load balancing. The load balancer chooses cluster and priority first
and then delegates the load balancing to the load balancer of the selected cluster. The top level
load balancer reuses the existing load balancing algorithm by linearizing the priority set of
multiple clusters into one.</p>
<div class="section" id="linearize-priority-set">
<h2>Linearize Priority Set<a class="headerlink" href="#linearize-priority-set" title="Permalink to this headline">¶</a></h2>
<p>Upstream hosts are divided into multiple <a class="reference internal" href="load_balancing/priority.html#arch-overview-load-balancing-priority-levels"><span class="std std-ref">priority levels</span></a>
and each priority level contains a list of healthy, degraded and unhealthy hosts. Linearization is
used to simplify the host selection during load balancing by merging priority levels from multiple
clusters. For example, primary cluster has 3 priority levels, secondary has 2 and tertiary has 2 and
the failover ordering is primary, secondary, tertiary.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 25%" />
<col style="width: 58%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Cluster</p></th>
<th class="head"><p>Priority Level</p></th>
<th class="head"><p>Priority Level after Linearization</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Primary</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>Primary</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>Primary</p></td>
<td><p>2</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>Secondary</p></td>
<td><p>0</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-even"><td><p>Secondary</p></td>
<td><p>1</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>Tertiary</p></td>
<td><p>0</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>Tertiary</p></td>
<td><p>1</p></td>
<td><p>6</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>A sample aggregate cluster configuration could be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">aggregate_cluster</span>
<span class="nt">connect_timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.25s</span>
<span class="nt">lb_policy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CLUSTER_PROVIDED</span>
<span class="nt">cluster_type</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.clusters.aggregate</span>
  <span class="nt">typed_config</span><span class="p">:</span>
    <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.clusters.aggregate.v3.ClusterConfig</span>
    <span class="nt">clusters</span><span class="p">:</span>
    <span class="c1"># cluster primary, secondary and tertiary should be defined outside.</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">secondary</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tertiary</span>
</pre></div>
</div>
<p>Note: <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retry-priority"><span class="std std-ref">PriorityLoad retry plugins</span></a> won’t
work for aggregate cluster because the aggregate load balancer will override the <em>PriorityLoad</em>
during load balancing.</p>
</div>
<div class="section" id="load-balancing-example">
<h2>Load Balancing Example<a class="headerlink" href="#load-balancing-example" title="Permalink to this headline">¶</a></h2>
<p>Aggregate cluster uses tiered load balancing algorithm and the top tier is distributing traffic to
different clusters according to the health score across all <a class="reference internal" href="load_balancing/priority.html#arch-overview-load-balancing-priority-levels"><span class="std std-ref">priorities</span></a>
in each cluster. The aggregate cluster in this section includes two clusters which is different from
what the above configuration describes.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 13%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" colspan="5"><p>Cluster</p></th>
<th class="head"><p>Traffic to Primary</p></th>
<th class="head"><p>Traffic to Secondary</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="3"><p>Primary</p></td>
<td colspan="2"><p>Secondary</p></td>
<td colspan="2" rowspan="2"></td>
</tr>
<tr class="row-odd"><td><p>P=0 Healthy Endpoints</p></td>
<td><p>P=1 Healthy Endpoints</p></td>
<td><p>P=2 Healthy Endpoints</p></td>
<td><p>P=0 Healthy Endpoints</p></td>
<td><p>P=1 Healthy Endpoints</p></td>
</tr>
<tr class="row-even"><td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>72%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-even"><td><p>71%</p></td>
<td><p>1%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
</tr>
<tr class="row-odd"><td><p>71%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
<td><p>100%</p></td>
<td><p>99%</p></td>
<td><p>1%</p></td>
</tr>
<tr class="row-even"><td><p>50%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>50%</p></td>
<td><p>0%</p></td>
<td><p>70%</p></td>
<td><p>30%</p></td>
</tr>
<tr class="row-odd"><td><p>20%</p></td>
<td><p>20%</p></td>
<td><p>10%</p></td>
<td><p>25%</p></td>
<td><p>25%</p></td>
<td><p>70%</p></td>
<td><p>30%</p></td>
</tr>
<tr class="row-even"><td><p>20%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>20%</p></td>
<td><p>0%</p></td>
<td><p>50%</p></td>
<td><p>50%</p></td>
</tr>
<tr class="row-odd"><td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
</tr>
<tr class="row-even"><td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>72%</p></td>
<td><p>0%</p></td>
<td><p>0%</p></td>
<td><p>100%</p></td>
</tr>
</tbody>
</table>
<p>Note: The above load balancing uses default <a class="reference internal" href="load_balancing/overprovisioning.html#arch-overview-load-balancing-overprovisioning-factor"><span class="std std-ref">overprovisioning factor</span></a>
which is 1.4 which means if 80% of the endpoints in a priority level are healthy, that level is
still considered fully healthy because 80 * 1.4 &gt; 100.</p>
<p>The example shows how the aggregate cluster level load balancer selects the cluster. E.g., healths
of {{20, 20, 10}, {25, 25}} would result in a priority load of {{28%, 28%, 14%}, {30%, 0%}} of
traffic. When normalized total health drops below 100, traffic is distributed after normalizing the
levels’ health scores to that sub-100 total. E.g. healths of {{20, 0, 0}, {20, 0}} (yielding a
normalized total health of 56) would be normalized and each cluster will receive 20 * 1.4 / 56 = 50%
of the traffic which results in a priority load of {{50%, 0%, 0%}, {50%, 0%, 0%}} of traffic.</p>
<p>The load balancer reuses priority level logic to help with the cluster selection. The priority level
logic works with integer health scores. The health score of a level is (percent of healthy hosts in
the level) * (overprovisioning factor), capped at 100%. P=0 endpoints receive level 0’s health
score percent of the traffic, with the rest flowing to P=1 (assuming P=1 is 100% healthy - more on
that later). The integer percents of traffic that each cluster receives are collectively called the
system’s “cluster priority load”. For instance, for primary cluster, when 20% of P=0 endpoints are
healthy, 20% of P=1 endpoints are healthy, and 10% of P=2 endpoints are healthy; for secondary, when
25% of P=0 endpoints are healthy and 25% of P=1 endpoints are healthy. The primary cluster will
receive 20% * 1.4 + 20% * 1.4 + 10% * 1.4 = 70% of the traffic. The secondary cluster will receive
min(100 - 70, 25% * 1.4 + 25% * 1.4) = 30% of the traffic. The traffic to all clusters sum up to
100. The normalized health score and priority load are pre-computed before selecting the cluster and
priority.</p>
<p>To sum this up in pseudo algorithms:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">1.4</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">healthy_P_X_backends</span> <span class="o">/</span> <span class="n">total_P_X_backends</span><span class="p">),</span> <span class="n">where</span>
                <span class="n">total_P_X_backends</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">backends</span> <span class="k">for</span> <span class="n">priority</span> <span class="n">P_X</span> <span class="n">after</span> <span class="n">linearization</span>
<span class="n">normalized_total_health</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">Σ</span><span class="p">(</span><span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">...</span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">)))</span>
<span class="n">cluster_priority_load</span><span class="p">(</span><span class="n">C_0</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">Σ</span><span class="p">(</span><span class="n">health</span><span class="p">(</span><span class="n">P_0</span><span class="p">)</span><span class="o">...</span><span class="n">health</span><span class="p">(</span><span class="n">P_k</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">),</span>
                <span class="n">where</span> <span class="n">P_0</span><span class="o">...</span><span class="n">P_k</span> <span class="n">belong</span> <span class="n">to</span> <span class="n">C_0</span>
<span class="n">cluster_priority_load</span><span class="p">(</span><span class="n">C_X</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">Σ</span><span class="p">(</span><span class="n">priority_load</span><span class="p">(</span><span class="n">C_0</span><span class="p">)</span><span class="o">..</span><span class="n">priority_load</span><span class="p">(</span><span class="n">C_X</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                         <span class="n">Σ</span><span class="p">(</span><span class="n">health</span><span class="p">(</span><span class="n">P_x</span><span class="p">)</span><span class="o">...</span><span class="n">health</span><span class="p">(</span><span class="n">P_X</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">normalized_total_health</span><span class="p">),</span>
                         <span class="n">where</span> <span class="n">P_x</span><span class="o">...</span><span class="n">P_X</span> <span class="n">belong</span> <span class="n">to</span> <span class="n">C_X</span>
<span class="nb">map</span> <span class="kn">from</span> <span class="nn">priorities</span> <span class="n">to</span> <span class="n">clusters</span><span class="p">:</span>
  <span class="n">P_0</span> <span class="o">...</span> <span class="n">P_k</span> <span class="o">...</span> <span class="o">...</span><span class="n">P_x</span> <span class="o">...</span> <span class="n">P_X</span>
  <span class="o">^</span>       <span class="o">^</span>          <span class="o">^</span>       <span class="o">^</span>
  <span class="n">cluster</span> <span class="n">C_0</span>        <span class="n">cluster</span> <span class="n">C_X</span>
</pre></div>
</div>
<p>The second tier is delegating the load balancing to the cluster selected in the first step and the
cluster could use any load balancing algorithms specified by <a class="reference internal" href="load_balancing/load_balancers.html#arch-overview-load-balancing-types"><span class="std std-ref">load balancer type</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="outlier.html" class="btn btn-neutral float-right" title="Outlier detection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="load_balancing/subsets.html" class="btn btn-neutral float-left" title="Load Balancer Subsets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>