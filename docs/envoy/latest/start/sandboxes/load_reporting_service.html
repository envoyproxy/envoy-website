

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Load Reporting Service (LRS) &mdash; envoy 1.16.0-dev-1c2739 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
        <script src="../../_static/sphinx_tabs/tabs.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Lua Filter" href="lua.html" />
    <link rel="prev" title="Jaeger Tracing" href="jaeger_tracing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-dev-1c2739
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../start.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../start.html#quick-start-to-run-simple-example">Quick Start to Run Simple Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../start.html#simple-configuration">Simple Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../start.html#using-the-envoy-docker-image">Using the Envoy Docker Image</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../start.html#sandboxes">Sandboxes</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="cache.html">Cache Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="cors.html">CORS Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="csrf.html">CSRF Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext_authz.html">External Authorization Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="fault_injection.html">Fault Injection Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="front_proxy.html">Front Proxy</a></li>
<li class="toctree-l3"><a class="reference internal" href="grpc_bridge.html">gRPC Bridge</a></li>
<li class="toctree-l3"><a class="reference internal" href="jaeger_native_tracing.html">Jaeger Native Tracing</a></li>
<li class="toctree-l3"><a class="reference internal" href="jaeger_tracing.html">Jaeger Tracing</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Load Reporting Service (LRS)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-the-sandbox">Running the Sandbox</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lua.html">Lua Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="mysql.html">MySQL Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="redis.html">Redis Filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="zipkin_tracing.html">Zipkin Tracing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../start.html#other-use-cases">Other use cases</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/configuration.html">Configuration reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../start.html">Getting Started</a> &raquo;</li>
        
      <li>Load Reporting Service (LRS)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/start/sandboxes/load_reporting_service.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="load-reporting-service-lrs">
<span id="install-sandboxes-load-reporting-service"></span><h1>Load Reporting Service (LRS)<a class="headerlink" href="#load-reporting-service-lrs" title="Permalink to this headline">¶</a></h1>
<p>This simple example demonstrates Envoy’s Load Reporting Service (LRS) capability and how to use it.</p>
<p>Lets say Cluster A (downstream) talks to Cluster B (Upstream) and Cluster C (Upstream). When enabling Load Report for
Cluster A, LRS server should be sending LoadStatsResponse to Cluster A with LoadStatsResponse.Clusters to be B and C.
LRS server will then receive LoadStatsRequests (with total requests, successful requests etc) from Cluster A to Cluster B and
from Cluster A to Cluster C.</p>
<p>In this example, all incoming requests are routed via Envoy to a simple goLang web server aka http_server.
We scale up two containers and randomly send requests to each. Envoy is configured to initiate the connection with LRS Server.
LRS Server enables the stats by sending LoadStatsResponse. Sending requests to http_server will be counted towards successful requests and will be visible in LRS Server logs.</p>
<div class="section" id="running-the-sandbox">
<h2>Running the Sandbox<a class="headerlink" href="#running-the-sandbox" title="Permalink to this headline">¶</a></h2>
<p>The following documentation runs through the setup of Envoy described above.</p>
<p><strong>Step 1: Install Docker</strong></p>
<p>Ensure that you have a recent versions of <code class="docutils literal notranslate"><span class="pre">docker</span></code> and <code class="docutils literal notranslate"><span class="pre">docker-compose</span></code> installed.</p>
<p>A simple way to achieve this is via the <a class="reference external" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>.</p>
<p><strong>Step 2: Clone the Envoy repo</strong></p>
<p>If you have not cloned the Envoy repo, clone it with:</p>
<div class="sphinx-tabs docutils container">
<div class="ui top attached tabular menu sphinx-menu docutils container">
<div class="active item sphinx-data-tab-U1NI docutils container">
<div class="docutils container">
<p>SSH</p>
</div>
</div>
<div class="item sphinx-data-tab-SFRUUFM= docutils container">
<div class="docutils container">
<p>HTTPS</p>
</div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment code-tab sphinx-data-tab-U1NI active docutils container">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">git clone git@github.com:envoyproxy/envoy</span>
</pre></div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment code-tab sphinx-data-tab-SFRUUFM= docutils container">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">git clone https://github.com/envoyproxy/envoy.git</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Step 3: Build the sandbox</strong></p>
<p>Terminal 1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pwd
envoy/examples/load_reporting_service
$ docker-compose pull
$ docker-compose up --scale http_service=2
</pre></div>
</div>
<p>Terminal 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pwd
envoy/examples/load_reporting_service
$ docker-compose ps

                            Name                               Command               State                           Ports
--------------------------------------------------------------------------------------------------------------------------------------
load-reporting-service_http_service_1   /bin/sh -c /usr/local/bin/ ... Up      10000/tcp, 0.0.0.0:80-&gt;80/tcp, 0.0.0.0:8081-&gt;8081/tcp
load-reporting-service_http_service_2   /bin/sh -c /usr/local/bin/ ... Up      10000/tcp, 0.0.0.0:81-&gt;80/tcp, 0.0.0.0:8082-&gt;8081/tcp
load-reporting-service_lrs_server_1     go run main.go                   Up      0.0.0.0:18000-&gt;18000/tcp
</pre></div>
</div>
<p><strong>Step 4: Start sending stream of HTTP requests</strong></p>
<p>Terminal 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pwd
envoy/examples/load_reporting_service
$ bash send_requests.sh
</pre></div>
</div>
<p>The script above (<code class="docutils literal notranslate"><span class="pre">send_requests.sh</span></code>) sends requests randomly to each Envoy, which in turn forwards the requests to the backend service.</p>
<p><strong>Step 5: See Envoy Stats</strong></p>
<p>You should see</p>
<p>Terminal 1</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>............................
lrs_server_1    | 2020/02/12 17:08:20 LRS Server is up and running on :18000
lrs_server_1    | 2020/02/12 17:08:23 Adding new cluster to cache `http_service` with node `0022a319e1e2`
lrs_server_1    | 2020/02/12 17:08:24 Adding new node `2417806c9d9a` to existing cluster `http_service`
lrs_server_1    | 2020/02/12 17:08:25 Creating LRS response for cluster http_service, node 2417806c9d9a with frequency 2 secs
lrs_server_1    | 2020/02/12 17:08:25 Creating LRS response for cluster http_service, node 0022a319e1e2 with frequency 2 secs
http_service_2  | 127.0.0.1 - - [12/Feb/2020 17:09:06] &quot;GET /service HTTP/1.1&quot; 200 -
http_service_1  | 127.0.0.1 - - [12/Feb/2020 17:09:06] &quot;GET /service HTTP/1.1&quot; 200 -
............................
lrs_server_1    | 2020/02/12 17:09:07 Got stats from cluster `http_service` node `0022a319e1e2` - cluster_name:&quot;local_service&quot; upstream_locality_stats:&lt;locality:&lt;&gt; total_successful_requests:21 total_issued_requests:21 &gt; load_report_interval:&lt;seconds:1 nanos:998411000 &gt;
lrs_server_1    | 2020/02/12 17:09:07 Got stats from cluster `http_service` node `2417806c9d9a` - cluster_name:&quot;local_service&quot; upstream_locality_stats:&lt;locality:&lt;&gt; total_successful_requests:17 total_issued_requests:17 &gt; load_report_interval:&lt;seconds:1 nanos:994529000 &gt;
http_service_2  | 127.0.0.1 - - [12/Feb/2020 17:09:07] &quot;GET /service HTTP/1.1&quot; 200 -
http_service_1  | 127.0.0.1 - - [12/Feb/2020 17:09:07] &quot;GET /service HTTP/1.1&quot; 200 -
............................
lrs_server_1    | 2020/02/12 17:09:09 Got stats from cluster `http_service` node `0022a319e1e2` - cluster_name:&quot;local_service&quot; upstream_locality_stats:&lt;locality:&lt;&gt; total_successful_requests:3 total_issued_requests:3 &gt; load_report_interval:&lt;seconds:2 nanos:2458000 &gt;
lrs_server_1    | 2020/02/12 17:09:09 Got stats from cluster `http_service` node `2417806c9d9a` - cluster_name:&quot;local_service&quot; upstream_locality_stats:&lt;locality:&lt;&gt; total_successful_requests:9 total_issued_requests:9 &gt; load_report_interval:&lt;seconds:2 nanos:6487000 &gt;
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lua.html" class="btn btn-neutral float-right" title="Lua Filter" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jaeger_tracing.html" class="btn btn-neutral float-left" title="Jaeger Tracing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>