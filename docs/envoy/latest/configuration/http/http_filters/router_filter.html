

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Router &mdash; envoy 1.15.0-dev-ae1f15 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Squash" href="squash_filter.html" />
    <link rel="prev" title="Role Based Access Control (RBAC) Filter" href="rbac_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.15.0-dev-ae1f15
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api-v3/extensions/filters/http/cache/v3alpha/cache.proto.html">HTTP Cache Filter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>Router</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_filters/router_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="router">
<span id="config-http-filters-router"></span><h1>Router<a class="headerlink" href="#router" title="Permalink to this headline">¶</a></h1>
<p>The router filter implements HTTP forwarding. It will be used in almost all HTTP proxy scenarios
that Envoy is deployed for. The filter’s main job is to follow the instructions specified in the
configured <a class="reference internal" href="../../../api-v3/config/route/v3/route.proto.html#envoy-v3-api-msg-config-route-v3-routeconfiguration"><span class="std std-ref">route table</span></a>. In addition to forwarding and
redirection, the filter also handles retry, statistics, etc.</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/router/v3/router.proto.html#envoy-v3-api-msg-extensions-filters-http-router-v3-router"><span class="std std-ref">v3 API reference</span></a></p></li>
<li><p>This filter should be configured with the name <em>envoy.filters.http.router</em>.</p></li>
</ul>
<div class="section" id="http-headers-consumed">
<span id="config-http-filters-router-headers-consumed"></span><h2>HTTP headers (consumed)<a class="headerlink" href="#http-headers-consumed" title="Permalink to this headline">¶</a></h2>
<p>The router consumes and sets various HTTP headers both on the egress/request path as well as on the
ingress/response path. They are documented in this section.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#x-envoy-max-retries" id="id3">x-envoy-max-retries</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-retry-on" id="id4">x-envoy-retry-on</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-retry-grpc-on" id="id5">x-envoy-retry-grpc-on</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-retriable-header-names" id="id6">x-envoy-retriable-header-names</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-retriable-status-codes" id="id7">x-envoy-retriable-status-codes</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-alt-stat-name" id="id8">x-envoy-upstream-alt-stat-name</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-canary" id="id9">x-envoy-upstream-canary</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-rq-timeout-alt-response" id="id10">x-envoy-upstream-rq-timeout-alt-response</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-rq-timeout-ms" id="id11">x-envoy-upstream-rq-timeout-ms</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-rq-per-try-timeout-ms" id="id12">x-envoy-upstream-rq-per-try-timeout-ms</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-hedge-on-per-try-timeout" id="id13">x-envoy-hedge-on-per-try-timeout</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-immediate-health-check-fail" id="id14">x-envoy-immediate-health-check-fail</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-ratelimited" id="id15">x-envoy-ratelimited</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-decorator-operation" id="id16">x-envoy-decorator-operation</a></p></li>
</ul>
</div>
<div class="section" id="x-envoy-max-retries">
<span id="config-http-filters-router-x-envoy-max-retries"></span><h3><a class="toc-backref" href="#id3">x-envoy-max-retries</a><a class="headerlink" href="#x-envoy-max-retries" title="Permalink to this headline">¶</a></h3>
<p>If a <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route config retry policy</span></a> or a
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host retry policy</span></a> is in place, Envoy will default to retrying
one time unless explicitly specified. The number of retries can be explicitly set in the virtual host retry config,
the route retry config, or by using this header. If this header is used, its value takes precedence over the number of
retries set in either retry policy. If a retry policy is not configured and <a class="reference internal" href="#config-http-filters-router-x-envoy-retry-on"><span class="std std-ref">x-envoy-retry-on</span></a>
or <a class="reference internal" href="#config-http-filters-router-x-envoy-retry-grpc-on"><span class="std std-ref">x-envoy-retry-grpc-on</span></a> headers are not specified, Envoy will not retry a failed request.</p>
<p>A few notes on how Envoy does retries:</p>
<ul class="simple">
<li><p>The route timeout (set via <a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a> or the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-timeout"><span class="std std-ref">timeout</span></a> in route configuration or set via
<a class="reference external" href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">grpc-timeout header</a>  by specifying
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-timeout"><span class="std std-ref">max_grpc_timeout</span></a> in route configuration) <strong>includes</strong> all
retries. Thus if the request timeout is set to 3s, and the first request attempt takes 2.7s, the
retry (including back-off) has .3s to complete. This is by design to avoid an exponential
retry/timeout explosion.</p></li>
<li><p>Envoy uses a fully jittered exponential back-off algorithm for retries with a default base
interval of 25ms. Given a base interval B and retry number N, the back-off for the retry is in
the range <span class="math notranslate nohighlight">\(\big[0, (2^N-1)B\big)\)</span>. For example, given the default interval, the first retry
will be delayed randomly by 0-24ms, the 2nd by 0-74ms, the 3rd by 0-174ms, and so on. The
interval is capped at a maximum interval, which defaults to 10 times the base interval (250ms).
The default base interval (and therefore the maximum interval) can be manipulated by setting the
upstream.base_retry_backoff_ms runtime parameter. The back-off intervals can also be modified
by configuring the retry policy’s
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retry-back-off"><span class="std std-ref">retry back-off</span></a>.</p></li>
<li><p>If max retries is set both by header as well as in the route configuration, the maximum value is
taken when determining the max retries to use for the request.</p></li>
</ul>
</div>
<div class="section" id="x-envoy-retry-on">
<span id="config-http-filters-router-x-envoy-retry-on"></span><h3><a class="toc-backref" href="#id4">x-envoy-retry-on</a><a class="headerlink" href="#x-envoy-retry-on" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to attempt to retry failed requests (number
of retries defaults to 1 and can be controlled by <a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">x-envoy-max-retries</span></a> header or the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route config retry policy</span></a> or the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host retry policy</span></a>).
The value to which the x-envoy-retry-on header is set indicates the retry policy. One or more policies
can be specified using a ‘,’ delimited list. The supported policies are:</p>
<dl class="simple">
<dt>5xx</dt><dd><p>Envoy will attempt a retry if the upstream server responds with any 5xx response code, or does not
respond at all (disconnect/reset/read timeout). (Includes <em>connect-failure</em> and <em>refused-stream</em>)</p>
<ul class="simple">
<li><p><strong>NOTE:</strong> Envoy will not retry when a request exceeds
<a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a> (resulting in a 504 error
code). Use <a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-per-try-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-per-try-timeout-ms</span></a> if you want
to retry when individual attempts take too long.
<a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a> is an outer time limit for a
request, including any retries that take place.</p></li>
</ul>
</dd>
<dt>gateway-error</dt><dd><p>This policy is similar to the <em>5xx</em> policy but will only retry requests that result in a 502, 503,
or 504.</p>
</dd>
<dt>reset</dt><dd><p>Envoy will attempt a retry if the upstream server does not respond at all (disconnect/reset/read timeout.)</p>
</dd>
<dt>connect-failure</dt><dd><p>Envoy will attempt a retry if a request is failed because of a connection failure to the upstream
server (connect timeout, etc.). (Included in <em>5xx</em>)</p>
<ul class="simple">
<li><p><strong>NOTE:</strong> A connection failure/timeout is a the TCP level, not the request level. This does not
include upstream request timeouts specified via
<a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a> or via <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route
configuration</span></a> or via
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host retry policy</span></a>.</p></li>
</ul>
</dd>
<dt>retriable-4xx</dt><dd><p>Envoy will attempt a retry if the upstream server responds with a retriable 4xx response code.
Currently, the only response code in this category is 409.</p>
<ul class="simple">
<li><p><strong>NOTE:</strong> Be careful turning on this retry type. There are certain cases where a 409 can indicate
that an optimistic locking revision needs to be updated. Thus, the caller should not retry and
needs to read then attempt another write. If a retry happens in this type of case it will always
fail with another 409.</p></li>
</ul>
</dd>
<dt>refused-stream</dt><dd><p>Envoy will attempt a retry if the upstream server resets the stream with a REFUSED_STREAM error
code. This reset type indicates that a request is safe to retry. (Included in <em>5xx</em>)</p>
</dd>
<dt>retriable-status-codes</dt><dd><p>Envoy will attempt a retry if the upstream server responds with any response code matching one defined
in either <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retriable-status-codes"><span class="std std-ref">the retry policy</span></a>
or in the <a class="reference internal" href="#config-http-filters-router-x-envoy-retriable-status-codes"><span class="std std-ref">x-envoy-retriable-status-codes</span></a> header.</p>
</dd>
<dt>retriable-headers</dt><dd><p>Envoy will attempt a retry if the upstream server response includes any headers matching in either
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retriable-headers"><span class="std std-ref">the retry policy</span></a> or in the
<a class="reference internal" href="#config-http-filters-router-x-envoy-retriable-header-names"><span class="std std-ref">x-envoy-retriable-header-names</span></a> header.</p>
</dd>
</dl>
<p>The number of retries can be controlled via the
<a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">x-envoy-max-retries</span></a> header or via the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route
configuration</span></a> or via the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host retry policy</span></a>.</p>
<p>Note that retry policies can also be applied at the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route level</span></a> or the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host level</span></a>.</p>
<p>By default, Envoy will <em>not</em> perform retries unless you’ve configured them per above.</p>
</div>
<div class="section" id="x-envoy-retry-grpc-on">
<span id="config-http-filters-router-x-envoy-retry-grpc-on"></span><h3><a class="toc-backref" href="#id5">x-envoy-retry-grpc-on</a><a class="headerlink" href="#x-envoy-retry-grpc-on" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to attempt to retry failed requests (number of
retries defaults to 1, and can be controlled by
<a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">x-envoy-max-retries</span></a>
header or the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route config retry policy</span></a>) or the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host retry policy</span></a>.
gRPC retries are currently only supported for gRPC status codes in response headers. gRPC status codes in
trailers will not trigger retry logic. One or more policies can be specified  using a ‘,’ delimited
list. The supported policies are:</p>
<dl class="simple">
<dt>cancelled</dt><dd><p>Envoy will attempt a retry if the gRPC status code in the response headers is “cancelled” (1)</p>
</dd>
<dt>deadline-exceeded</dt><dd><p>Envoy will attempt a retry if the gRPC status code in the response headers is “deadline-exceeded” (4)</p>
</dd>
<dt>internal</dt><dd><p>Envoy will attempt to retry if the gRPC status code in the response headers is “internal” (13)</p>
</dd>
<dt>resource-exhausted</dt><dd><p>Envoy will attempt a retry if the gRPC status code in the response headers is “resource-exhausted” (8)</p>
</dd>
<dt>unavailable</dt><dd><p>Envoy will attempt a retry if the gRPC status code in the response headers is “unavailable” (14)</p>
</dd>
</dl>
<p>As with the x-envoy-retry-grpc-on header, the number of retries can be controlled via the
<a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">x-envoy-max-retries</span></a> header</p>
<p>Note that retry policies can also be applied at the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-retry-policy"><span class="std std-ref">route level</span></a> or the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-retry-policy"><span class="std std-ref">virtual host level</span></a>.</p>
<p>By default, Envoy will <em>not</em> perform retries unless you’ve configured them per above.</p>
</div>
<div class="section" id="x-envoy-retriable-header-names">
<span id="config-http-filters-router-x-envoy-retriable-header-names"></span><h3><a class="toc-backref" href="#id6">x-envoy-retriable-header-names</a><a class="headerlink" href="#x-envoy-retriable-header-names" title="Permalink to this headline">¶</a></h3>
<p>Setting this header informs Envoy about what response headers should be considered retriable. It is used
in conjunction with the <a class="reference internal" href="#config-http-filters-router-x-envoy-retry-on"><span class="std std-ref">retriable-headers</span></a> retry policy.
When the corresponding retry policy is set, the response headers provided by this list header value will be
considered retriable in addition to the response headers enabled for retry through other retry policies.</p>
<p>The list is a comma-separated list of header names: “X-Upstream-Retry,X-Try-Again” would cause any upstream
responses containing either one of the specified headers to be retriable if ‘retriable-headers’ retry policy
is enabled. Header names are case-insensitive.</p>
<p>Only the names of retriable response headers can be specified via the request header. A more sophisticated
retry policy based on the response headers can be specified by using arbitrary header matching rules
via <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-retrypolicy-retriable-headers"><span class="std std-ref">retry policy configuration</span></a>.</p>
<p>This header will only be honored for requests from internal clients.</p>
</div>
<div class="section" id="x-envoy-retriable-status-codes">
<span id="config-http-filters-router-x-envoy-retriable-status-codes"></span><h3><a class="toc-backref" href="#id7">x-envoy-retriable-status-codes</a><a class="headerlink" href="#x-envoy-retriable-status-codes" title="Permalink to this headline">¶</a></h3>
<p>Setting this header informs Envoy about what status codes should be considered retriable when used in
conjunction with the <a class="reference internal" href="#config-http-filters-router-x-envoy-retry-on"><span class="std std-ref">retriable-status-code</span></a> retry policy.
When the corresponding retry policy is set, the list of retriable status codes will be considered retriable
in addition to the status codes enabled for retry through other retry policies.</p>
<p>The list is a comma delimited list of integers: “409” would cause 409 to be considered retriable, while “504,409”
would consider both 504 and 409 retriable.</p>
<p>This header will only be honored for requests from internal clients.</p>
</div>
<div class="section" id="x-envoy-upstream-alt-stat-name">
<span id="config-http-filters-router-x-envoy-upstream-alt-stat-name"></span><h3><a class="toc-backref" href="#id8">x-envoy-upstream-alt-stat-name</a><a class="headerlink" href="#x-envoy-upstream-alt-stat-name" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to emit upstream response code/timing
statistics to a dual stat tree. This can be useful for application level categories that Envoy
doesn’t know about. The output tree is documented <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-alt-tree"><span class="std std-ref">here</span></a>.</p>
<p>This should not be confused with <a class="reference internal" href="../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-alt-stat-name"><span class="std std-ref">alt_stat_name</span></a> which
is specified while defining the cluster and when provided specifies an alternative name for the
cluster at the root of the statistic tree.</p>
</div>
<div class="section" id="x-envoy-upstream-canary">
<h3><a class="toc-backref" href="#id9">x-envoy-upstream-canary</a><a class="headerlink" href="#x-envoy-upstream-canary" title="Permalink to this headline">¶</a></h3>
<p>If an upstream host sets this header, the router will use it to generate canary specific statistics.
The output tree is documented <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats-dynamic-http"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="x-envoy-upstream-rq-timeout-alt-response">
<span id="config-http-filters-router-x-envoy-upstream-rq-timeout-alt-response"></span><h3><a class="toc-backref" href="#id10">x-envoy-upstream-rq-timeout-alt-response</a><a class="headerlink" href="#x-envoy-upstream-rq-timeout-alt-response" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to set a 204 response code (instead of 504)
in the event of a request timeout. The actual value of the header is ignored; only its presence
is considered. See also <a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a>.</p>
</div>
<div class="section" id="x-envoy-upstream-rq-timeout-ms">
<span id="config-http-filters-router-x-envoy-upstream-rq-timeout-ms"></span><h3><a class="toc-backref" href="#id11">x-envoy-upstream-rq-timeout-ms</a><a class="headerlink" href="#x-envoy-upstream-rq-timeout-ms" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to override the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-timeout"><span class="std std-ref">route configuration timeout</span></a> or gRPC client timeout set via <a class="reference external" href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">grpc-timeout header</a>  by specifying <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-timeout"><span class="std std-ref">max_grpc_timeout</span></a>. The timeout must be specified in millisecond
units. See also <a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-per-try-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-per-try-timeout-ms</span></a>.</p>
</div>
<div class="section" id="x-envoy-upstream-rq-per-try-timeout-ms">
<span id="config-http-filters-router-x-envoy-upstream-rq-per-try-timeout-ms"></span><h3><a class="toc-backref" href="#id12">x-envoy-upstream-rq-per-try-timeout-ms</a><a class="headerlink" href="#x-envoy-upstream-rq-per-try-timeout-ms" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to set a <em>per try</em> timeout on routed
requests. If a global route timeout is configured, this timeout must be less than the global route
timeout (see <a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a>) or it is ignored.
This allows a caller to set a tight per try timeout to allow for retries while maintaining a
reasonable overall timeout. This timeout only applies before any part of the response is sent to
the downstream, which normally happens after the upstream has sent response headers.</p>
</div>
<div class="section" id="x-envoy-hedge-on-per-try-timeout">
<h3><a class="toc-backref" href="#id13">x-envoy-hedge-on-per-try-timeout</a><a class="headerlink" href="#x-envoy-hedge-on-per-try-timeout" title="Permalink to this headline">¶</a></h3>
<p>Setting this header on egress requests will cause Envoy to use a request
hedging strategy in the case of a per try timeout. This overrides the value set
in the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-hedgepolicy-hedge-on-per-try-timeout"><span class="std std-ref">route configuration</span></a>. This means that a retry
will be issued without resetting the original request, leaving multiple upstream requests
in flight.</p>
<p>The value of the header should be “true” or “false”, and is ignored if invalid.</p>
</div>
<div class="section" id="x-envoy-immediate-health-check-fail">
<span id="config-http-filters-router-x-envoy-immediate-health-check-fail"></span><h3><a class="toc-backref" href="#id14">x-envoy-immediate-health-check-fail</a><a class="headerlink" href="#x-envoy-immediate-health-check-fail" title="Permalink to this headline">¶</a></h3>
<p>If the upstream host returns this header (set to any value), Envoy will immediately assume the
upstream host has failed <a class="reference internal" href="../../../intro/arch_overview/upstream/health_checking.html#arch-overview-health-checking"><span class="std std-ref">active health checking</span></a> (if the
cluster has been <a class="reference internal" href="../../upstream/cluster_manager/cluster_hc.html#config-cluster-manager-cluster-hc"><span class="std std-ref">configured</span></a> for active health checking).
This can be used to fast fail an upstream host via standard data plane processing without waiting
for the next health check interval. The host can become healthy again via standard active health
checks. See the <a class="reference internal" href="../../../intro/arch_overview/upstream/health_checking.html#arch-overview-health-checking"><span class="std std-ref">health checking overview</span></a> for more
information.</p>
</div>
<div class="section" id="x-envoy-ratelimited">
<span id="config-http-filters-router-x-envoy-ratelimited"></span><h3><a class="toc-backref" href="#id15">x-envoy-ratelimited</a><a class="headerlink" href="#x-envoy-ratelimited" title="Permalink to this headline">¶</a></h3>
<p>If this header is set by upstream, Envoy will not retry. Currently the value of the header is not
looked at, only its presence. This header is set by <a class="reference internal" href="rate_limit_filter.html#config-http-filters-rate-limit"><span class="std std-ref">rate limit filter</span></a>
when the request is rate limited.</p>
</div>
<div class="section" id="x-envoy-decorator-operation">
<span id="config-http-filters-router-x-envoy-decorator-operation"></span><h3><a class="toc-backref" href="#id16">x-envoy-decorator-operation</a><a class="headerlink" href="#x-envoy-decorator-operation" title="Permalink to this headline">¶</a></h3>
<p>If this header is present on ingress requests, its value will override any locally defined
operation (span) name on the server span generated by the tracing mechanism. Similarly, if
this header is present on an egress response, its value will override any locally defined
operation (span) name on the client span.</p>
</div>
</div>
<div class="section" id="http-headers-set">
<span id="config-http-filters-router-headers-set"></span><h2>HTTP headers (set)<a class="headerlink" href="#http-headers-set" title="Permalink to this headline">¶</a></h2>
<p>The router sets various HTTP headers both on the egress/request path as well as on the
ingress/response path. They are documented in this section.</p>
<div class="contents local topic" id="id2">
<ul class="simple">
<li><p><a class="reference internal" href="#x-envoy-attempt-count" id="id17">x-envoy-attempt-count</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-expected-rq-timeout-ms" id="id18">x-envoy-expected-rq-timeout-ms</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-upstream-service-time" id="id19">x-envoy-upstream-service-time</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-original-path" id="id20">x-envoy-original-path</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-overloaded" id="id21">x-envoy-overloaded</a></p></li>
</ul>
</div>
<div class="section" id="x-envoy-attempt-count">
<span id="config-http-filters-router-x-envoy-attempt-count"></span><h3><a class="toc-backref" href="#id17">x-envoy-attempt-count</a><a class="headerlink" href="#x-envoy-attempt-count" title="Permalink to this headline">¶</a></h3>
<p>Sent to the upstream to indicate which attempt the current request is in a series of retries. The value
will be “1” on the initial request, incrementing by one for each retry. Only set if the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-include-request-attempt-count"><span class="std std-ref">include_request_attempt_count</span></a>
flag is set to true.</p>
<p>Sent to the downstream to indicate how many upstream requests took place. The header will be absent if
the router did not send any upstream requests. The value will be “1” if only the original upstream
request was sent, incrementing by one for each retry. Only set if the
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-virtualhost-include-attempt-count-in-response"><span class="std std-ref">include_attempt_count_in_response</span></a>
flag is set to true.</p>
</div>
<div class="section" id="x-envoy-expected-rq-timeout-ms">
<span id="config-http-filters-router-x-envoy-expected-rq-timeout-ms"></span><h3><a class="toc-backref" href="#id18">x-envoy-expected-rq-timeout-ms</a><a class="headerlink" href="#x-envoy-expected-rq-timeout-ms" title="Permalink to this headline">¶</a></h3>
<p>This is the time in milliseconds the router expects the request to be completed. Envoy sets this
header so that the upstream host receiving the request can make decisions based on the request
timeout, e.g., early exit. This is set on internal requests and is either taken from the
<a class="reference internal" href="#config-http-filters-router-x-envoy-upstream-rq-timeout-ms"><span class="std std-ref">x-envoy-upstream-rq-timeout-ms</span></a> header or the <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-timeout"><span class="std std-ref">route timeout</span></a>, in that order.</p>
</div>
<div class="section" id="x-envoy-upstream-service-time">
<h3><a class="toc-backref" href="#id19">x-envoy-upstream-service-time</a><a class="headerlink" href="#x-envoy-upstream-service-time" title="Permalink to this headline">¶</a></h3>
<p>Contains the time in milliseconds spent by the upstream host processing the request. This is useful
if the client wants to determine service time compared to network latency. This header is set on
responses.</p>
</div>
<div class="section" id="x-envoy-original-path">
<span id="config-http-filters-router-x-envoy-original-path"></span><h3><a class="toc-backref" href="#id20">x-envoy-original-path</a><a class="headerlink" href="#x-envoy-original-path" title="Permalink to this headline">¶</a></h3>
<p>If the route utilizes <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-prefix-rewrite"><span class="std std-ref">prefix_rewrite</span></a>
or <a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-regex-rewrite"><span class="std std-ref">regex_rewrite</span></a>,
Envoy will put the original path header in this header. This can be useful for logging and
debugging.</p>
</div>
<div class="section" id="x-envoy-overloaded">
<span id="config-http-filters-router-x-envoy-overloaded-set"></span><h3><a class="toc-backref" href="#id21">x-envoy-overloaded</a><a class="headerlink" href="#x-envoy-overloaded" title="Permalink to this headline">¶</a></h3>
<p>Envoy will set this header on the downstream response
if a request was dropped due to either <a class="reference internal" href="#config-http-filters-router-runtime-maintenance-mode"><span class="std std-ref">maintenance mode</span></a> or upstream <a class="reference internal" href="../../../intro/arch_overview/upstream/circuit_breaking.html#arch-overview-circuit-break"><span class="std std-ref">circuit breaking</span></a>.</p>
</div>
</div>
<div class="section" id="statistics">
<span id="config-http-filters-router-stats"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>The router outputs many statistics in the cluster namespace (depending on the cluster specified in
the chosen route). See <a class="reference internal" href="../../upstream/cluster_manager/cluster_stats.html#config-cluster-manager-cluster-stats"><span class="std std-ref">here</span></a> for more information.</p>
<p>The router filter outputs statistics in the <em>http.&lt;stat_prefix&gt;.</em> namespace. The <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-stat-prefix"><span class="std std-ref">stat prefix</span></a> comes from the
owning HTTP connection manager.</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>no_route</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that had no route and resulted in a 404</p></td>
</tr>
<tr class="row-odd"><td><p>no_cluster</p></td>
<td><p>Counter</p></td>
<td><p>Total requests in which the target cluster did not exist and which by default result in a 503</p></td>
</tr>
<tr class="row-even"><td><p>rq_redirect</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that resulted in a redirect response</p></td>
</tr>
<tr class="row-odd"><td><p>rq_direct_response</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that resulted in a direct response</p></td>
</tr>
<tr class="row-even"><td><p>rq_total</p></td>
<td><p>Counter</p></td>
<td><p>Total routed requests</p></td>
</tr>
<tr class="row-odd"><td><p>rq_reset_after_downstream_response_started</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that were reset after downstream response had started</p></td>
</tr>
</tbody>
</table>
<div class="section" id="virtual-clusters">
<span id="config-http-filters-router-vcluster-stats"></span><h3>Virtual Clusters<a class="headerlink" href="#virtual-clusters" title="Permalink to this headline">¶</a></h3>
<p>Virtual cluster statistics are output in the
<em>vhost.&lt;virtual host name&gt;.vcluster.&lt;virtual cluster name&gt;.</em> namespace and include the following
statistics:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>upstream_rq_&lt;*xx&gt;</p></td>
<td><p>Counter</p></td>
<td><p>Aggregate HTTP response codes (e.g., 2xx, 3xx, etc.)</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_rq_&lt;*&gt;</p></td>
<td><p>Counter</p></td>
<td><p>Specific HTTP response codes (e.g., 201, 302, etc.)</p></td>
</tr>
<tr class="row-even"><td><p>upstream_rq_retry</p></td>
<td><p>Counter</p></td>
<td><p>Total request retries</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_rq_retry_limit_exceeded</p></td>
<td><p>Counter</p></td>
<td><p>Total requests not retried due to exceeding <a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">the configured number of maximum retries</span></a></p></td>
</tr>
<tr class="row-even"><td><p>upstream_rq_retry_overflow</p></td>
<td><p>Counter</p></td>
<td><p>Total requests not retried due to circuit breaking or exceeding the <a class="reference internal" href="../../../api-v3/config/cluster/v3/circuit_breaker.proto.html#envoy-v3-api-field-config-cluster-v3-circuitbreakers-thresholds-retry-budget"><span class="std std-ref">retry budgets</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>upstream_rq_retry_success</p></td>
<td><p>Counter</p></td>
<td><p>Total request retry successes</p></td>
</tr>
<tr class="row-even"><td><p>upstream_rq_time</p></td>
<td><p>Histogram</p></td>
<td><p>Request time milliseconds</p></td>
</tr>
<tr class="row-odd"><td><p>upstream_rq_timeout</p></td>
<td><p>Counter</p></td>
<td><p>Total requests that timed out waiting for a response</p></td>
</tr>
<tr class="row-even"><td><p>upstream_rq_total</p></td>
<td><p>Counter</p></td>
<td><p>Total requests initiated by the router to the upstream</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="runtime">
<h2>Runtime<a class="headerlink" href="#runtime" title="Permalink to this headline">¶</a></h2>
<p>The router filter supports the following runtime settings:</p>
<dl class="simple">
<dt>upstream.base_retry_backoff_ms</dt><dd><p>Base exponential retry back-off time. See <a class="reference internal" href="../../../intro/arch_overview/http/http_routing.html#arch-overview-http-routing-retry"><span class="std std-ref">here</span></a> and
<a class="reference internal" href="#config-http-filters-router-x-envoy-max-retries"><span class="std std-ref">x-envoy-max-retries</span></a> for more information. Defaults to 25ms.
The default maximum retry back-off time is 10 times this value.</p>
</dd>
</dl>
<dl class="simple" id="config-http-filters-router-runtime-maintenance-mode">
<dt>upstream.maintenance_mode.&lt;cluster name&gt;</dt><dd><p>% of requests that will result in an immediate 503 response. This overrides any routing behavior
for requests that would have been destined for &lt;cluster name&gt;. This can be used for load
shedding, failure injection, etc. Defaults to disabled.</p>
</dd>
<dt>upstream.use_retry</dt><dd><p>% of requests that are eligible for retry. This configuration is checked before any other retry
configuration and can be used to fully disable retries across all Envoys if needed.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="squash_filter.html" class="btn btn-neutral float-right" title="Squash" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rbac_filter.html" class="btn btn-neutral float-left" title="Role Based Access Control (RBAC) Filter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>