

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Compressor &mdash; envoy 1.16.0-dev-5f3a35 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="CORS" href="cors_filter.html" />
    <link rel="prev" title="Buffer" href="buffer_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.16.0-dev-5f3a35
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Building and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_to_metadata_filter.html">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api-v3/extensions/filters/http/admission_control/v3alpha/admission_control.proto.html">Admission Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../api-v3/extensions/filters/http/cache/v3alpha/cache.proto.html">HTTP Cache Filter</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>Compressor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_filters/compressor_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="compressor">
<span id="config-http-filters-compressor"></span><h1>Compressor<a class="headerlink" href="#compressor" title="Permalink to this headline">¶</a></h1>
<p>Compressor is an HTTP filter which enables Envoy to compress dispatched data
from an upstream service upon client request. Compression is useful in
situations when bandwidth is scarce and large payloads can be effectively compressed
at the expense of higher CPU load or offloading it to a compression accelerator.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This filter deprecates the <a class="reference internal" href="gzip_filter.html#config-http-filters-gzip"><span class="std std-ref">HTTP Gzip filter</span></a>.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/compressor/v3/compressor.proto.html#envoy-v3-api-msg-extensions-filters-http-compressor-v3-compressor"><span class="std std-ref">v3 API reference</span></a></p></li>
<li><p>This filter should be configured with the name <em>envoy.filters.http.compressor</em>.</p></li>
</ul>
</div>
<div class="section" id="how-it-works">
<h2>How it works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">¶</a></h2>
<p>When compressor filter is enabled, request and response headers are inspected to
determine whether or not the content should be compressed. The content is
compressed and then sent to the client with the appropriate headers, if
response and request allow.</p>
<p>Currently the filter supports <a class="reference internal" href="../../../api-v3/extensions/compression/gzip/compressor/v3/gzip.proto.html#envoy-v3-api-msg-extensions-compression-gzip-compressor-v3-gzip"><span class="std std-ref">gzip compression</span></a>
only. Other compression libraries can be supported as extensions.</p>
<p>An example configuration of the filter may look like the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">http_filters</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.compressor</span>
  <span class="nt">typed_config</span><span class="p">:</span>
    <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.compressor.v3.Compressor</span>
    <span class="nt">disable_on_etag_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">content_length</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="nt">content_type</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">text/html</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">application/json</span>
    <span class="nt">compressor_library</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">text_optimized</span>
      <span class="nt">typed_config</span><span class="p">:</span>
        <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.compression.gzip.compressor.v3.Gzip</span>
        <span class="nt">memory_level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
        <span class="nt">window_bits</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">compression_level</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">best_compression</span>
        <span class="nt">compression_strategy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default_strategy</span>
</pre></div>
</div>
<p>By <em>default</em> compression will be <em>skipped</em> when:</p>
<ul class="simple">
<li><p>A request does NOT contain <em>accept-encoding</em> header.</p></li>
<li><p>A request includes <em>accept-encoding</em> header, but it does not contain “gzip” or “*”.</p></li>
<li><p>A request includes <em>accept-encoding</em> with “gzip” or “*” with the weight “q=0”. Note
that the “gzip” will have a higher weight then “*”. For example, if <em>accept-encoding</em>
is “gzip;q=0,*;q=1”, the filter will not compress. But if the header is set to
“*;q=0,gzip;q=1”, the filter will compress.</p></li>
<li><p>A request whose <em>accept-encoding</em> header includes any encoding type with a higher
weight than “gzip“‘s given the corresponding compression filter is present in the chain.</p></li>
<li><p>A response contains a <em>content-encoding</em> header.</p></li>
<li><p>A response contains a <em>cache-control</em> header whose value includes “no-transform”.</p></li>
<li><p>A response contains a <em>transfer-encoding</em> header whose value includes “gzip”.</p></li>
<li><p>A response does not contain a <em>content-type</em> value that matches one of the selected
mime-types, which default to <em>application/javascript</em>, <em>application/json</em>,
<em>application/xhtml+xml</em>, <em>image/svg+xml</em>, <em>text/css</em>, <em>text/html</em>, <em>text/plain</em>,
<em>text/xml</em>.</p></li>
<li><p>Neither <em>content-length</em> nor <em>transfer-encoding</em> headers are present in
the response.</p></li>
<li><p>Response size is smaller than 30 bytes (only applicable when <em>transfer-encoding</em>
is not chunked).</p></li>
</ul>
<p>Please note that in case the filter is configured to use a compression library extension
other than gzip it looks for content encoding in the <em>accept-encoding</em> header provided by
the extension.</p>
<p>When compression is <em>applied</em>:</p>
<ul class="simple">
<li><p>The <em>content-length</em> is removed from response headers.</p></li>
<li><p>Response headers contain “<em>transfer-encoding: chunked</em>” and do not contain
“<em>content-encoding</em>” header.</p></li>
<li><p>The “<em>vary: accept-encoding</em>” header is inserted on every response.</p></li>
</ul>
<p>Also the “<em>vary: accept-encoding</em>” header may be inserted even if compression is <em>not</em>
applied due to incompatible “<em>accept-encoding</em>” header in a request. This happens
when the requested resource still can be compressed given compatible “<em>accept-encoding</em>”.
Otherwise, if an uncompressed response is cached by a caching proxy in front of Envoy,
the proxy won’t know to fetch a new incoming request with compatible “<em>accept-encoding</em>”
from upstream.</p>
</div>
<div class="section" id="statistics">
<span id="compressor-statistics"></span><h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>Every configured Compressor filter has statistics rooted at
&lt;stat_prefix&gt;.compressor.&lt;compressor_library.name&gt;.&lt;compressor_library_stat_prefix&gt;.*
with the following:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>compressed</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests compressed.</p></td>
</tr>
<tr class="row-odd"><td><p>not_compressed</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests not compressed.</p></td>
</tr>
<tr class="row-even"><td><p>no_accept_header</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests with no accept header sent.</p></td>
</tr>
<tr class="row-odd"><td><p>header_identity</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests sent with “identity” set as the <em>accept-encoding</em>.</p></td>
</tr>
<tr class="row-even"><td><p>header_compressor_used</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests sent with “gzip” set as the <em>accept-encoding</em>.</p></td>
</tr>
<tr class="row-odd"><td><p>header_compressor_overshadowed</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests skipped by this filter instance because they were handled by another filter in the same filter chain.</p></td>
</tr>
<tr class="row-even"><td><p>header_wildcard</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests sent with “*” set as the <em>accept-encoding</em>.</p></td>
</tr>
<tr class="row-odd"><td><p>header_not_valid</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests sent with a not valid <em>accept-encoding</em> header (aka “q=0” or an unsupported encoding type).</p></td>
</tr>
<tr class="row-even"><td><p>total_uncompressed_bytes</p></td>
<td><p>Counter</p></td>
<td><p>The total uncompressed bytes of all the requests that were marked for compression.</p></td>
</tr>
<tr class="row-odd"><td><p>total_compressed_bytes</p></td>
<td><p>Counter</p></td>
<td><p>The total compressed bytes of all the requests that were marked for compression.</p></td>
</tr>
<tr class="row-even"><td><p>content_length_too_small</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests that accepted gzip encoding but did not compress because the payload was too small.</p></td>
</tr>
<tr class="row-odd"><td><p>not_compressed_etag</p></td>
<td><p>Counter</p></td>
<td><p>Number of requests that were not compressed due to the etag header. <em>disable_on_etag_header</em> must be turned on for this to happen.</p></td>
</tr>
</tbody>
</table>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cors_filter.html" class="btn btn-neutral float-right" title="CORS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="buffer_filter.html" class="btn btn-neutral float-left" title="Buffer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>