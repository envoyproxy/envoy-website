

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Envoy Header-To-Metadata Filter &mdash; envoy 1.17.0-dev-7fe3a8 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="IP Tagging" href="ip_tagging_filter.html" />
    <link rel="prev" title="Health check" href="health_check_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-dev-7fe3a8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../http_conn_man/http_conn_man.html">HTTP connection manager</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="http_filters.html">HTTP filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="adaptive_concurrency_filter.html">Adaptive Concurrency</a></li>
<li class="toctree-l4"><a class="reference internal" href="admission_control_filter.html">Admission Control</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_lambda_filter.html">AWS Lambda</a></li>
<li class="toctree-l4"><a class="reference internal" href="aws_request_signing_filter.html">AWS Request Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffer_filter.html">Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="cdn_loop_filter.html">CDN-Loop header</a></li>
<li class="toctree-l4"><a class="reference internal" href="compressor_filter.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="cors_filter.html">CORS</a></li>
<li class="toctree-l4"><a class="reference internal" href="csrf_filter.html">CSRF</a></li>
<li class="toctree-l4"><a class="reference internal" href="decompressor_filter.html">Decompressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamic_forward_proxy_filter.html">Dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="dynamodb_filter.html">DynamoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_proc_filter.html">External Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="fault_filter.html">Fault Injection</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_bridge_filter.html">gRPC HTTP/1.1 bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_http1_reverse_bridge_filter.html">gRPC HTTP/1.1 reverse bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_json_transcoder_filter.html">gRPC-JSON transcoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_stats_filter.html">gRPC Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="grpc_web_filter.html">gRPC-Web</a></li>
<li class="toctree-l4"><a class="reference internal" href="gzip_filter.html">Gzip</a></li>
<li class="toctree-l4"><a class="reference internal" href="health_check_filter.html">Health check</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Envoy Header-To-Metadata Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="ip_tagging_filter.html">IP Tagging</a></li>
<li class="toctree-l4"><a class="reference internal" href="jwt_authn_filter.html">JWT Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="kill_request_filter.html">Kill Request</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="lua_filter.html">Lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="oauth2_filter.html">OAuth2</a></li>
<li class="toctree-l4"><a class="reference internal" href="on_demand_updates_filter.html">On-demand VHDS and S/RDS Updates</a></li>
<li class="toctree-l4"><a class="reference internal" href="original_src_filter.html">Original Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="router_filter.html">Router</a></li>
<li class="toctree-l4"><a class="reference internal" href="squash_filter.html">Squash</a></li>
<li class="toctree-l4"><a class="reference internal" href="tap_filter.html">Tap</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_filters.html">HTTP filters</a> &raquo;</li>
        
      <li>Envoy Header-To-Metadata Filter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_filters/header_to_metadata_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="envoy-header-to-metadata-filter">
<span id="config-http-filters-header-to-metadata"></span><h1>Envoy Header-To-Metadata Filter<a class="headerlink" href="#envoy-header-to-metadata-filter" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/http/header_to_metadata/v3/header_to_metadata.proto.html#envoy-v3-api-msg-extensions-filters-http-header-to-metadata-v3-config"><span class="std std-ref">v3 API reference</span></a></p></li>
<li><p>This filter should be configured with the name <em>envoy.filters.http.header_to_metadata</em>.</p></li>
</ul>
<p>This filter is configured with rules that will be matched against requests and responses.
Each rule has either a cookie or a header and can be triggered either when the header
or cookie is present or missing.</p>
<p>When a rule is triggered, dynamic metadata will be added based on the configuration of the rule.
If the header or cookie is present, it’s value is extracted and used along with the specified
key as metadata. If the header or cookie is missing, on missing case is triggered and the value
specified is used for adding metadata.</p>
<p>The metadata can then be used for load balancing decisions, consumed from logs, etc.</p>
<p>A typical use case for this filter is to dynamically match requests with load balancer
subsets. For this, a given header’s value would be extracted and attached to the request
as dynamic metadata which would then be used to match a subset of endpoints.</p>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>A sample filter configuration to route traffic to endpoints based on the presence or
absence of a version header could be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">http_filters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.header_to_metadata</span>
    <span class="nt">typed_config</span><span class="p">:</span>
      <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config</span>
      <span class="nt">request_rules</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">x-version</span>
          <span class="nt">on_header_present</span><span class="p">:</span>
            <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
            <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">version</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STRING</span>
          <span class="nt">on_header_missing</span><span class="p">:</span>
            <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
            <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
            <span class="nt">value</span><span class="p">:</span> <span class="s">&#39;true&#39;</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STRING</span>
          <span class="nt">remove</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>As with headers, the value of the specified cookie will be extracted from the request
and added as metadata with the key specified.
Removing a cookie when a rule matches is unsupported.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">http_filters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.header_to_metadata</span>
    <span class="nt">typed_config</span><span class="p">:</span>
      <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config</span>
      <span class="nt">request_rules</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">cookie</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cookie</span>
          <span class="nt">on_header_present</span><span class="p">:</span>
            <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
            <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">version</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STRING</span>
          <span class="nt">on_header_missing</span><span class="p">:</span>
            <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
            <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
            <span class="nt">value</span><span class="p">:</span> <span class="s">&#39;true&#39;</span>
            <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STRING</span>
          <span class="nt">remove</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
<p>A corresponding upstream cluster configuration could be:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">clusters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">versioned-cluster</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">EDS</span>
    <span class="nt">lb_policy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ROUND_ROBIN</span>
    <span class="nt">lb_subset_config</span><span class="p">:</span>
      <span class="nt">fallback_policy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ANY_ENDPOINT</span>
      <span class="nt">subset_selectors</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">keys</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
        <span class="p p-Indicator">-</span> <span class="nt">keys</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">version</span>
</pre></div>
</div>
<p>This would then allow requests with the <cite>x-version</cite> header set to be matched against
endpoints with the corresponding version. Whereas requests with that header missing
would be matched with the default endpoints.</p>
<p>If the header’s value needs to be transformed before it’s added to the request as
dynamic metadata, this filter supports regex matching and substitution:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">http_filters</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.http.header_to_metadata</span>
    <span class="nt">typed_config</span><span class="p">:</span>
      <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config</span>
      <span class="nt">request_rules</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">header</span><span class="p">:</span> <span class="s">&quot;:path&quot;</span>
          <span class="nt">on_header_present</span><span class="p">:</span>
            <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
            <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster</span>
            <span class="nt">regex_value_rewrite</span><span class="p">:</span>
              <span class="nt">pattern</span><span class="p">:</span>
                <span class="nt">google_re2</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
                <span class="nt">regex</span><span class="p">:</span> <span class="s">&quot;^/(cluster[\\d\\w-]+)/?.*$&quot;</span>
              <span class="nt">substitution</span><span class="p">:</span> <span class="s">&quot;\\1&quot;</span>
</pre></div>
</div>
<p>Note that this filter also supports per route configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">route_config</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local_route</span>
  <span class="nt">virtual_hosts</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local_service</span>
    <span class="nt">domains</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">routes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> prefix</span><span class="p">:</span> <span class="s">&quot;/version-to-metadata&quot;</span> <span class="p p-Indicator">}</span>
      <span class="nt">route</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> cluster</span><span class="p">:</span> <span class="nv">service</span> <span class="p p-Indicator">}</span>
      <span class="nt">typed_per_filter_config</span><span class="p">:</span>
        <span class="nt">envoy.filters.http.header_to_metadata</span><span class="p">:</span>
          <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.http.header_to_metadata.v3.Config</span>
          <span class="nt">request_rules</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">x-version</span>
              <span class="nt">on_header_present</span><span class="p">:</span>
                <span class="nt">metadata_namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.lb</span>
                <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">version</span>
                <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">STRING</span>
              <span class="nt">remove</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="p p-Indicator">-</span> <span class="nt">match</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> prefix</span><span class="p">:</span> <span class="s">&quot;/&quot;</span> <span class="p p-Indicator">}</span>
      <span class="nt">route</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nt"> cluster</span><span class="p">:</span> <span class="nv">some_service</span> <span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>This can be used to either override the global configuration or if the global configuration
is empty (no rules), it can be used to only enable the filter at a per route level.</p>
</div>
<div class="section" id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>Currently, this filter generates no statistics.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ip_tagging_filter.html" class="btn btn-neutral float-right" title="IP Tagging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="health_check_filter.html" class="btn btn-neutral float-left" title="Health check" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>