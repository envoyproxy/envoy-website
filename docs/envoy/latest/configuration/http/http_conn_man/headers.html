

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HTTP header manipulation &mdash; envoy 1.17.0-dev-5df0a6 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="HTTP header sanitizing" href="header_sanitizing.html" />
    <link rel="prev" title="HTTP/1.1 Header Casing" href="header_casing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-dev-5df0a6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../http.html">HTTP</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="http_conn_man.html">HTTP connection manager</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="route_matching.html">Route matching</a></li>
<li class="toctree-l4"><a class="reference internal" href="traffic_splitting.html">Traffic Shifting/Splitting</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_casing.html">HTTP/1.1 Header Casing</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">HTTP header manipulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="header_sanitizing.html">HTTP header sanitizing</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_reply.html">Local reply modification</a></li>
<li class="toctree-l4"><a class="reference internal" href="response_code_details.html">Response Code Details</a></li>
<li class="toctree-l4"><a class="reference internal" href="stats.html">Statistics</a></li>
<li class="toctree-l4"><a class="reference internal" href="runtime.html">Runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="rds.html">Route discovery service (RDS)</a></li>
<li class="toctree-l4"><a class="reference internal" href="vhds.html">Virtual Host Discovery Service (VHDS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../http_filters/http_filters.html">HTTP filters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../http.html">HTTP</a> &raquo;</li>
        
          <li><a href="http_conn_man.html">HTTP connection manager</a> &raquo;</li>
        
      <li>HTTP header manipulation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/http/http_conn_man/headers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="http-header-manipulation">
<span id="config-http-conn-man-headers"></span><h1>HTTP header manipulation<a class="headerlink" href="#http-header-manipulation" title="Permalink to this headline">¶</a></h1>
<p>The HTTP connection manager manipulates several HTTP headers both during decoding (when the request
is being received) as well as during encoding (when the response is being sent).</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#user-agent" id="id1">user-agent</a></p></li>
<li><p><a class="reference internal" href="#server" id="id2">server</a></p></li>
<li><p><a class="reference internal" href="#x-client-trace-id" id="id3">x-client-trace-id</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-downstream-service-cluster" id="id4">x-envoy-downstream-service-cluster</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-downstream-service-node" id="id5">x-envoy-downstream-service-node</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-external-address" id="id6">x-envoy-external-address</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-force-trace" id="id7">x-envoy-force-trace</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-internal" id="id8">x-envoy-internal</a></p></li>
<li><p><a class="reference internal" href="#x-envoy-original-dst-host" id="id9">x-envoy-original-dst-host</a></p></li>
<li><p><a class="reference internal" href="#x-forwarded-client-cert" id="id10">x-forwarded-client-cert</a></p></li>
<li><p><a class="reference internal" href="#x-forwarded-for" id="id11">x-forwarded-for</a></p></li>
<li><p><a class="reference internal" href="#x-forwarded-proto" id="id12">x-forwarded-proto</a></p></li>
<li><p><a class="reference internal" href="#x-request-id" id="id13">x-request-id</a></p></li>
<li><p><a class="reference internal" href="#x-ot-span-context" id="id14">x-ot-span-context</a></p></li>
<li><p><a class="reference internal" href="#x-b3-traceid" id="id15">x-b3-traceid</a></p></li>
<li><p><a class="reference internal" href="#x-b3-spanid" id="id16">x-b3-spanid</a></p></li>
<li><p><a class="reference internal" href="#x-b3-parentspanid" id="id17">x-b3-parentspanid</a></p></li>
<li><p><a class="reference internal" href="#x-b3-sampled" id="id18">x-b3-sampled</a></p></li>
<li><p><a class="reference internal" href="#x-b3-flags" id="id19">x-b3-flags</a></p></li>
<li><p><a class="reference internal" href="#b3" id="id20">b3</a></p></li>
<li><p><a class="reference internal" href="#x-datadog-trace-id" id="id21">x-datadog-trace-id</a></p></li>
<li><p><a class="reference internal" href="#x-datadog-parent-id" id="id22">x-datadog-parent-id</a></p></li>
<li><p><a class="reference internal" href="#x-datadog-sampling-priority" id="id23">x-datadog-sampling-priority</a></p></li>
<li><p><a class="reference internal" href="#custom-request-response-headers" id="id24">Custom request/response headers</a></p></li>
</ul>
</div>
<div class="section" id="user-agent">
<span id="config-http-conn-man-headers-user-agent"></span><h2><a class="toc-backref" href="#id1">user-agent</a><a class="headerlink" href="#user-agent" title="Permalink to this headline">¶</a></h2>
<p>The <em>user-agent</em> header may be set by the connection manager during decoding if the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-add-user-agent"><span class="std std-ref">add_user_agent</span></a> option is
enabled. The header is only modified if it is not already set. If the connection manager does set the header, the value
is determined by the <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> command line option.</p>
</div>
<div class="section" id="server">
<span id="config-http-conn-man-headers-server"></span><h2><a class="toc-backref" href="#id2">server</a><a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h2>
<p>The <em>server</em> header will be set during encoding to the value in the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-server-name"><span class="std std-ref">server_name</span></a> option.</p>
</div>
<div class="section" id="x-client-trace-id">
<span id="config-http-conn-man-headers-x-client-trace-id"></span><h2><a class="toc-backref" href="#id3">x-client-trace-id</a><a class="headerlink" href="#x-client-trace-id" title="Permalink to this headline">¶</a></h2>
<p>If an external client sets this header, Envoy will join the provided trace ID with the internally
generated <a class="reference internal" href="#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a>. x-client-trace-id needs to be globally
unique and generating a uuid4 is recommended. If this header is set, it has similar effect to
<a class="reference internal" href="#config-http-conn-man-headers-x-envoy-force-trace"><span class="std std-ref">x-envoy-force-trace</span></a>. See the <a class="reference internal" href="runtime.html#config-http-conn-man-runtime-client-enabled"><span class="std std-ref">tracing.client_enabled</span></a> runtime configuration setting.</p>
</div>
<div class="section" id="x-envoy-downstream-service-cluster">
<span id="config-http-conn-man-headers-downstream-service-cluster"></span><h2><a class="toc-backref" href="#id4">x-envoy-downstream-service-cluster</a><a class="headerlink" href="#x-envoy-downstream-service-cluster" title="Permalink to this headline">¶</a></h2>
<p>Internal services often want to know which service is calling them. This header is cleaned from
external requests, but for internal requests will contain the service cluster of the caller. Note
that in the current implementation, this should be considered a hint as it is set by the caller and
could be easily spoofed by any internal entity. In the future Envoy will support a mutual
authentication TLS mesh which will make this header fully secure. Like <em>user-agent</em>, the value
is determined by the <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-cluster"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-cluster</span></code></a> command line option. In order to enable this
feature you need to set the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-add-user-agent"><span class="std std-ref">user_agent</span></a> option to true.</p>
</div>
<div class="section" id="x-envoy-downstream-service-node">
<span id="config-http-conn-man-headers-downstream-service-node"></span><h2><a class="toc-backref" href="#id5">x-envoy-downstream-service-node</a><a class="headerlink" href="#x-envoy-downstream-service-node" title="Permalink to this headline">¶</a></h2>
<p>Internal services may want to know the downstream node request comes from. This header
is quite similar to <a class="reference internal" href="#config-http-conn-man-headers-downstream-service-cluster"><span class="std std-ref">x-envoy-downstream-service-cluster</span></a>, except the value is taken from
the  <a class="reference internal" href="../../../operations/cli.html#cmdoption-service-node"><code class="xref std std-option docutils literal notranslate"><span class="pre">--service-node</span></code></a> option.</p>
</div>
<div class="section" id="x-envoy-external-address">
<span id="config-http-conn-man-headers-x-envoy-external-address"></span><h2><a class="toc-backref" href="#id6">x-envoy-external-address</a><a class="headerlink" href="#x-envoy-external-address" title="Permalink to this headline">¶</a></h2>
<p>It is a common case where a service wants to perform analytics based on the origin client’s IP
address. Per the lengthy discussion on <a class="reference internal" href="#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">XFF</span></a>,
this can get quite complicated, so Envoy simplifies this by setting <em>x-envoy-external-address</em>
to the <a class="reference internal" href="#config-http-conn-man-headers-x-forwarded-for-trusted-client-address"><span class="std std-ref">trusted client address</span></a>
if the request is from an external client. <em>x-envoy-external-address</em> is not set or overwritten
for internal requests. This header can be safely forwarded between internal services for analytics
purposes without having to deal with the complexities of XFF.</p>
</div>
<div class="section" id="x-envoy-force-trace">
<span id="config-http-conn-man-headers-x-envoy-force-trace"></span><h2><a class="toc-backref" href="#id7">x-envoy-force-trace</a><a class="headerlink" href="#x-envoy-force-trace" title="Permalink to this headline">¶</a></h2>
<p>If an internal request sets this header, Envoy will modify the generated
<a class="reference internal" href="#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> such that it forces traces to be collected.
This also forces <a class="reference internal" href="#config-http-conn-man-headers-x-request-id"><span class="std std-ref">x-request-id</span></a> to be returned in the response
headers. If this request ID is then propagated to other hosts, traces will also be collected on
those hosts which will provide a consistent trace for an entire request flow. See the
<a class="reference internal" href="runtime.html#config-http-conn-man-runtime-global-enabled"><span class="std std-ref">tracing.global_enabled</span></a> and
<a class="reference internal" href="runtime.html#config-http-conn-man-runtime-random-sampling"><span class="std std-ref">tracing.random_sampling</span></a> runtime
configuration settings.</p>
</div>
<div class="section" id="x-envoy-internal">
<span id="config-http-conn-man-headers-x-envoy-internal"></span><h2><a class="toc-backref" href="#id8">x-envoy-internal</a><a class="headerlink" href="#x-envoy-internal" title="Permalink to this headline">¶</a></h2>
<p>It is a common case where a service wants to know whether a request is internal origin or not. Envoy
uses <a class="reference internal" href="#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">XFF</span></a> to determine this and then will set
the header value to <em>true</em>.</p>
<p>This is a convenience to avoid having to parse and understand XFF.</p>
</div>
<div class="section" id="x-envoy-original-dst-host">
<span id="config-http-conn-man-headers-x-envoy-original-dst-host"></span><h2><a class="toc-backref" href="#id9">x-envoy-original-dst-host</a><a class="headerlink" href="#x-envoy-original-dst-host" title="Permalink to this headline">¶</a></h2>
<p>The header used to override destination address when using the
<a class="reference internal" href="../../../intro/arch_overview/upstream/load_balancing/original_dst.html#arch-overview-load-balancing-types-original-destination"><span class="std std-ref">Original Destination</span></a>
load balancing policy.</p>
<p>It is ignored, unless the use of it is enabled via
<a class="reference internal" href="../../../api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-field-config-cluster-v3-cluster-originaldstlbconfig-use-http-header"><span class="std std-ref">use_http_header</span></a>.</p>
</div>
<div class="section" id="x-forwarded-client-cert">
<span id="config-http-conn-man-headers-x-forwarded-client-cert"></span><h2><a class="toc-backref" href="#id10">x-forwarded-client-cert</a><a class="headerlink" href="#x-forwarded-client-cert" title="Permalink to this headline">¶</a></h2>
<p><em>x-forwarded-client-cert</em> (XFCC) is a proxy header which indicates certificate information of part
or all of the clients or proxies that a request has flowed through, on its way from the client to the
server. A proxy may choose to sanitize/append/forward the XFCC header before proxying the request.</p>
<p>The XFCC header value is a comma (“,”) separated string. Each substring is an XFCC element, which
holds information added by a single proxy. A proxy can append the current client certificate
information as an XFCC element, to the end of the request’s XFCC header after a comma.</p>
<p>Each XFCC element is a semicolon “;” separated string. Each substring is a key-value pair, grouped
together by an equals (“=”) sign. The keys are case-insensitive, the values are case-sensitive. If
“,”, “;” or “=” appear in a value, the value should be double-quoted. Double-quotes in the value
should be replaced by backslash-double-quote (&quot;).</p>
<p>The following keys are supported:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">By</span></code> The Subject Alternative Name (URI type) of the current proxy’s certificate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Hash</span></code> The SHA 256 digest of the current client certificate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cert</span></code> The entire client certificate in URL encoded PEM format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Chain</span></code> The entire client certificate chain (including the leaf certificate) in URL encoded PEM format.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Subject</span></code> The Subject field of the current client certificate. The value is always double-quoted.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">URI</span></code> The URI type Subject Alternative Name field of the current client certificate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DNS</span></code> The DNS type Subject Alternative Name field of the current client certificate. A client certificate may contain multiple DNS type Subject Alternative Names, each will be a separate key-value pair.</p></li>
</ol>
<p>A client certificate may contain multiple Subject Alternative Name types. For details on different Subject Alternative Name types, please refer <a class="reference external" href="https://tools.ietf.org/html/rfc2459#section-4.2.1.7">RFC 2459</a>.</p>
<p>Some examples of the XFCC header are:</p>
<ol class="arabic simple">
<li><p>For one client certificate with only URI type Subject Alternative Name: <code class="docutils literal notranslate"><span class="pre">x-forwarded-client-cert:</span> <span class="pre">By=http://frontend.lyft.com;Hash=468ed33be74eee6556d90c0149c1309e9ba61d6425303443c0748a02dd8de688;Subject=&quot;/C=US/ST=CA/L=San</span> <span class="pre">Francisco/OU=Lyft/CN=Test</span> <span class="pre">Client&quot;;URI=http://testclient.lyft.com</span></code></p></li>
<li><p>For two client certificates with only URI type Subject Alternative Name: <code class="docutils literal notranslate"><span class="pre">x-forwarded-client-cert:</span> <span class="pre">By=http://frontend.lyft.com;Hash=468ed33be74eee6556d90c0149c1309e9ba61d6425303443c0748a02dd8de688;URI=http://testclient.lyft.com,By=http://backend.lyft.com;Hash=9ba61d6425303443c0748a02dd8de688468ed33be74eee6556d90c0149c1309e;URI=http://frontend.lyft.com</span></code></p></li>
<li><p>For one client certificate with both URI type and DNS type Subject Alternative Name: <code class="docutils literal notranslate"><span class="pre">x-forwarded-client-cert:</span> <span class="pre">By=http://frontend.lyft.com;Hash=468ed33be74eee6556d90c0149c1309e9ba61d6425303443c0748a02dd8de688;Subject=&quot;/C=US/ST=CA/L=San</span> <span class="pre">Francisco/OU=Lyft/CN=Test</span> <span class="pre">Client&quot;;URI=http://testclient.lyft.com;DNS=lyft.com;DNS=www.lyft.com</span></code></p></li>
</ol>
<p>How Envoy processes XFCC is specified by the
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-forward-client-cert-details"><span class="std std-ref">forward_client_cert_details</span></a>
and the
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-set-current-client-cert-details"><span class="std std-ref">set_current_client_cert_details</span></a>
HTTP connection manager options. If <em>forward_client_cert_details</em> is unset, the XFCC header will be sanitized by
default.</p>
</div>
<div class="section" id="x-forwarded-for">
<span id="config-http-conn-man-headers-x-forwarded-for"></span><h2><a class="toc-backref" href="#id11">x-forwarded-for</a><a class="headerlink" href="#x-forwarded-for" title="Permalink to this headline">¶</a></h2>
<p><em>x-forwarded-for</em> (XFF) is a standard proxy header which indicates the IP addresses that a request has
flowed through on its way from the client to the server. A compliant proxy will <em>append</em> the IP
address of the nearest client to the XFF list before proxying the request. Some examples of XFF are:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x-forwarded-for:</span> <span class="pre">50.0.0.1</span></code> (single client)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x-forwarded-for:</span> <span class="pre">50.0.0.1,</span> <span class="pre">40.0.0.1</span></code> (external proxy hop)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x-forwarded-for:</span> <span class="pre">50.0.0.1,</span> <span class="pre">10.0.0.1</span></code> (internal proxy hop)</p></li>
</ol>
<p>Envoy will only append to XFF if the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-use-remote-address"><span class="std std-ref">use_remote_address</span></a>
HTTP connection manager option is set to true and the <a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-skip-xff-append"><span class="std std-ref">skip_xff_append</span></a>
is set false. This means that if <em>use_remote_address</em> is false (which is the default) or
<em>skip_xff_append</em> is true, the connection manager operates in a transparent mode where it does not
modify XFF.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>In general, <em>use_remote_address</em> should be set to true when Envoy is deployed as an edge
node (aka a front proxy), whereas it may need to be set to false when Envoy is used as
an internal service node in a mesh deployment.</p>
</div>
<p id="config-http-conn-man-headers-x-forwarded-for-trusted-client-address">The value of <em>use_remote_address</em> controls how Envoy determines the <em>trusted client address</em>.
Given an HTTP request that has traveled through a series of zero or more proxies to reach
Envoy, the trusted client address is the earliest source IP address that is known to be
accurate. The source IP address of the immediate downstream node’s connection to Envoy is
trusted. XFF <em>sometimes</em> can be trusted. Malicious clients can forge XFF, but the last
address in XFF can be trusted if it was put there by a trusted proxy.</p>
<p>Envoy’s default rules for determining the trusted client address (<em>before</em> appending anything
to XFF) are:</p>
<ul class="simple">
<li><p>If <em>use_remote_address</em> is false and an XFF containing at least one IP address is
present in the request, the trusted client address is the <em>last</em> (rightmost) IP address in XFF.</p></li>
<li><p>Otherwise, the trusted client address is the source IP address of the immediate downstream
node’s connection to Envoy.</p></li>
</ul>
<p>In an environment where there are one or more trusted proxies in front of an edge
Envoy instance, the <em>xff_num_trusted_hops</em> configuration option can be used to trust
additional addresses from XFF:</p>
<ul class="simple">
<li><p>If <em>use_remote_address</em> is false and <em>xff_num_trusted_hops</em> is set to a value <em>N</em> that is
greater than zero, the trusted client address is the (N+1)th address from the right end
of XFF. (If the XFF contains fewer than N+1 addresses, Envoy falls back to using the
immediate downstream connection’s source address as trusted client address.)</p></li>
<li><p>If <em>use_remote_address</em> is true and <em>xff_num_trusted_hops</em> is set to a value <em>N</em> that is
greater than zero, the trusted client address is the Nth address from the right end
of XFF. (If the XFF contains fewer than N addresses, Envoy falls back to using the
immediate downstream connection’s source address as trusted client address.)</p></li>
</ul>
<p>Envoy uses the trusted client address contents to determine whether a request originated
externally or internally. This influences whether the
<a class="reference internal" href="#config-http-conn-man-headers-x-envoy-internal"><span class="std std-ref">x-envoy-internal</span></a> header is set.</p>
<dl>
<dt>Example 1: Envoy as edge proxy, without a trusted proxy in front of it</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = true</div>
<div class="line">xff_num_trusted_hops = 0</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 192.0.2.5</div>
<div class="line">XFF = “203.0.113.128, 203.0.113.10, 203.0.113.1”</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 192.0.2.5 (XFF is ignored)</div>
<div class="line">X-Envoy-External-Address is set to 192.0.2.5</div>
<div class="line">XFF is changed to “203.0.113.128, 203.0.113.10, 203.0.113.1, 192.0.2.5”</div>
<div class="line">X-Envoy-Internal is removed (if it was present in the incoming request)</div>
</div>
</dd>
</dl>
</dd>
<dt>Example 2: Envoy as internal proxy, with the Envoy edge proxy from Example 1 in front of it</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = false</div>
<div class="line">xff_num_trusted_hops = 0</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 10.11.12.13 (address of the Envoy edge proxy)</div>
<div class="line">XFF = “203.0.113.128, 203.0.113.10, 203.0.113.1, 192.0.2.5”</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 192.0.2.5 (last address in XFF is trusted)</div>
<div class="line">X-Envoy-External-Address is not modified</div>
<div class="line">X-Envoy-Internal is removed (if it was present in the incoming request)</div>
</div>
</dd>
</dl>
</dd>
<dt>Example 3: Envoy as edge proxy, with two trusted external proxies in front of it</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = true</div>
<div class="line">xff_num_trusted_hops = 2</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 192.0.2.5</div>
<div class="line">XFF = “203.0.113.128, 203.0.113.10, 203.0.113.1”</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 203.0.113.10 (2nd to last address in XFF is trusted)</div>
<div class="line">X-Envoy-External-Address is set to 203.0.113.10</div>
<div class="line">XFF is changed to “203.0.113.128, 203.0.113.10, 203.0.113.1, 192.0.2.5”</div>
<div class="line">X-Envoy-Internal is removed (if it was present in the incoming request)</div>
</div>
</dd>
</dl>
</dd>
<dt>Example 4: Envoy as internal proxy, with the edge proxy from Example 3 in front of it</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = false</div>
<div class="line">xff_num_trusted_hops = 2</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 10.11.12.13 (address of the Envoy edge proxy)</div>
<div class="line">XFF = “203.0.113.128, 203.0.113.10, 203.0.113.1, 192.0.2.5”</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 203.0.113.10</div>
<div class="line">X-Envoy-External-Address is not modified</div>
<div class="line">X-Envoy-Internal is removed (if it was present in the incoming request)</div>
</div>
</dd>
</dl>
</dd>
<dt>Example 5: Envoy as an internal proxy, receiving a request from an internal client</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = false</div>
<div class="line">xff_num_trusted_hops = 0</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 10.20.30.40 (address of the internal client)</div>
<div class="line">XFF is not present</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 10.20.30.40</div>
<div class="line">X-Envoy-External-Address remains unset</div>
<div class="line">X-Envoy-Internal is set to “false”</div>
</div>
</dd>
</dl>
</dd>
<dt>Example 6: The internal Envoy from Example 5, receiving a request proxied by another Envoy</dt><dd><dl>
<dt>Settings:</dt><dd><div class="line-block">
<div class="line">use_remote_address = false</div>
<div class="line">xff_num_trusted_hops = 0</div>
</div>
</dd>
<dt>Request details:</dt><dd><div class="line-block">
<div class="line">Downstream IP address = 10.20.30.50 (address of the Envoy instance proxying to this one)</div>
<div class="line">XFF = “10.20.30.40”</div>
</div>
</dd>
<dt>Result:</dt><dd><div class="line-block">
<div class="line">Trusted client address = 10.20.30.40</div>
<div class="line">X-Envoy-External-Address remains unset</div>
<div class="line">X-Envoy-Internal is set to “true”</div>
</div>
</dd>
</dl>
</dd>
</dl>
<p>A few very important notes about XFF:</p>
<ol class="arabic simple">
<li><p>If <em>use_remote_address</em> is set to true, Envoy sets the
<a class="reference internal" href="#config-http-conn-man-headers-x-envoy-external-address"><span class="std std-ref">x-envoy-external-address</span></a> header to the trusted
client address.</p></li>
</ol>
<ol class="arabic simple" id="config-http-conn-man-headers-x-forwarded-for-internal-origin" start="2">
<li><p>XFF is what Envoy uses to determine whether a request is internal origin or external origin.
If <em>use_remote_address</em> is set to true, the request is internal if and only if the
request contains no XFF and the immediate downstream node’s connection to Envoy has
an internal (RFC1918 or RFC4193) source address. If <em>use_remote_address</em> is false, the
request is internal if and only if XFF contains a single RFC1918 or RFC4193 address.</p>
<ul class="simple">
<li><p><strong>NOTE</strong>: If an internal service proxies an external request to another internal service, and
includes the original XFF header, Envoy will append to it on egress if
<a class="reference internal" href="../../../api-v3/extensions/filters/network/http_connection_manager/v3/http_connection_manager.proto.html#envoy-v3-api-field-extensions-filters-network-http-connection-manager-v3-httpconnectionmanager-use-remote-address"><span class="std std-ref">use_remote_address</span></a> is set. This will cause
the other side to think the request is external. Generally, this is what is intended if XFF is
being forwarded. If it is not intended, do not forward XFF, and forward
<a class="reference internal" href="#config-http-conn-man-headers-x-envoy-internal"><span class="std std-ref">x-envoy-internal</span></a> instead.</p></li>
<li><p><strong>NOTE</strong>: If an internal service call is forwarded to another internal service (preserving XFF),
Envoy will not consider it internal. This is a known “bug” due to the simplification of how
XFF is parsed to determine if a request is internal. In this scenario, do not forward XFF and
allow Envoy to generate a new one with a single internal origin IP.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="x-forwarded-proto">
<span id="config-http-conn-man-headers-x-forwarded-proto"></span><h2><a class="toc-backref" href="#id12">x-forwarded-proto</a><a class="headerlink" href="#x-forwarded-proto" title="Permalink to this headline">¶</a></h2>
<p>It is a common case where a service wants to know what the originating protocol (HTTP or HTTPS) was
of the connection terminated by front/edge Envoy. <em>x-forwarded-proto</em> contains this information. It
will be set to either <em>http</em> or <em>https</em>.</p>
</div>
<div class="section" id="x-request-id">
<span id="config-http-conn-man-headers-x-request-id"></span><h2><a class="toc-backref" href="#id13">x-request-id</a><a class="headerlink" href="#x-request-id" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-request-id</em> header is used by Envoy to uniquely identify a request as well as perform stable
access logging and tracing. Envoy will generate an <em>x-request-id</em> header for all external origin
requests (the header is sanitized). It will also generate an <em>x-request-id</em> header for internal
requests that do not already have one. This means that <em>x-request-id</em> can and should be propagated
between client applications in order to have stable IDs across the entire mesh. Due to the out of
process architecture of Envoy, the header can not be automatically forwarded by Envoy itself. This
is one of the few areas where a thin client library is needed to perform this duty. How that is done
is out of scope for this documentation. If <em>x-request-id</em> is propagated across all hosts, the
following features are available:</p>
<ul class="simple">
<li><p>Stable <a class="reference internal" href="../../observability/access_log/usage.html#config-access-log"><span class="std std-ref">access logging</span></a> via the
<a class="reference internal" href="../../../api-v3/config/accesslog/v3/accesslog.proto.html#envoy-v3-api-field-config-accesslog-v3-accesslogfilter-runtime-filter"><span class="std std-ref">v3 API runtime filter</span></a>.</p></li>
<li><p>Stable tracing when performing random sampling via the <a class="reference internal" href="runtime.html#config-http-conn-man-runtime-random-sampling"><span class="std std-ref">tracing.random_sampling</span></a> runtime setting or via forced tracing using the
<a class="reference internal" href="#config-http-conn-man-headers-x-envoy-force-trace"><span class="std std-ref">x-envoy-force-trace</span></a> and
<a class="reference internal" href="#config-http-conn-man-headers-x-client-trace-id"><span class="std std-ref">x-client-trace-id</span></a> headers.</p></li>
</ul>
</div>
<div class="section" id="x-ot-span-context">
<span id="config-http-conn-man-headers-x-ot-span-context"></span><h2><a class="toc-backref" href="#id14">x-ot-span-context</a><a class="headerlink" href="#x-ot-span-context" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-ot-span-context</em> HTTP header is used by Envoy to establish proper parent-child relationships
between tracing spans when used with the LightStep tracer.
For example, an egress span is a child of an ingress
span (if the ingress span was present). Envoy injects the <em>x-ot-span-context</em> header on ingress requests and
forwards it to the local service. Envoy relies on the application to propagate <em>x-ot-span-context</em> on
the egress call to an upstream. See more on tracing <a class="reference internal" href="../../../intro/arch_overview/observability/tracing.html#arch-overview-tracing"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="x-b3-traceid">
<span id="config-http-conn-man-headers-x-b3-traceid"></span><h2><a class="toc-backref" href="#id15">x-b3-traceid</a><a class="headerlink" href="#x-b3-traceid" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-b3-traceid</em> HTTP header is used by the Zipkin tracer in Envoy.
The TraceId is 64-bit in length and indicates the overall ID of the
trace. Every span in a trace shares this ID. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation">here</a>.</p>
</div>
<div class="section" id="x-b3-spanid">
<span id="config-http-conn-man-headers-x-b3-spanid"></span><h2><a class="toc-backref" href="#id16">x-b3-spanid</a><a class="headerlink" href="#x-b3-spanid" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-b3-spanid</em> HTTP header is used by the Zipkin tracer in Envoy.
The SpanId is 64-bit in length and indicates the position of the current
operation in the trace tree. The value should not be interpreted: it may or
may not be derived from the value of the TraceId. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation">here</a>.</p>
</div>
<div class="section" id="x-b3-parentspanid">
<span id="config-http-conn-man-headers-x-b3-parentspanid"></span><h2><a class="toc-backref" href="#id17">x-b3-parentspanid</a><a class="headerlink" href="#x-b3-parentspanid" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-b3-parentspanid</em> HTTP header is used by the Zipkin tracer in Envoy.
The ParentSpanId is 64-bit in length and indicates the position of the
parent operation in the trace tree. When the span is the root of the trace
tree, the ParentSpanId is absent. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation">here</a>.</p>
</div>
<div class="section" id="x-b3-sampled">
<span id="config-http-conn-man-headers-x-b3-sampled"></span><h2><a class="toc-backref" href="#id18">x-b3-sampled</a><a class="headerlink" href="#x-b3-sampled" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-b3-sampled</em> HTTP header is used by the Zipkin tracer in Envoy.
When the Sampled flag is either not specified or set to 1, the span will be reported to the tracing
system. Once Sampled is set to 0 or 1, the same
value should be consistently sent downstream. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation">here</a>.</p>
</div>
<div class="section" id="x-b3-flags">
<span id="config-http-conn-man-headers-x-b3-flags"></span><h2><a class="toc-backref" href="#id19">x-b3-flags</a><a class="headerlink" href="#x-b3-flags" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-b3-flags</em> HTTP header is used by the Zipkin tracer in Envoy.
The encode one or more options. For example, Debug is encoded as
<code class="docutils literal notranslate"><span class="pre">X-B3-Flags:</span> <span class="pre">1</span></code>. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation">here</a>.</p>
</div>
<div class="section" id="b3">
<span id="config-http-conn-man-headers-b3"></span><h2><a class="toc-backref" href="#id20">b3</a><a class="headerlink" href="#b3" title="Permalink to this headline">¶</a></h2>
<p>The <em>b3</em> HTTP header is used by the Zipkin tracer in Envoy.
Is a more compressed header format. See more on zipkin tracing
<a class="reference external" href="https://github.com/openzipkin/b3-propagation#single-header">here</a>.</p>
</div>
<div class="section" id="x-datadog-trace-id">
<span id="config-http-conn-man-headers-x-datadog-trace-id"></span><h2><a class="toc-backref" href="#id21">x-datadog-trace-id</a><a class="headerlink" href="#x-datadog-trace-id" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-datadog-trace-id</em> HTTP header is used by the Datadog tracer in Envoy.
The 64-bit value represents the ID of the overall trace, and is used to correlate
the spans.</p>
</div>
<div class="section" id="x-datadog-parent-id">
<span id="config-http-conn-man-headers-x-datadog-parent-id"></span><h2><a class="toc-backref" href="#id22">x-datadog-parent-id</a><a class="headerlink" href="#x-datadog-parent-id" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-datadog-parent-id</em> HTTP header is used by the Datadog tracer in Envoy.
The 64-bit value uniquely identifies the span within the trace, and is used to
create parent-child relationships between spans.</p>
</div>
<div class="section" id="x-datadog-sampling-priority">
<span id="config-http-conn-man-headers-x-datadog-sampling-priority"></span><h2><a class="toc-backref" href="#id23">x-datadog-sampling-priority</a><a class="headerlink" href="#x-datadog-sampling-priority" title="Permalink to this headline">¶</a></h2>
<p>The <em>x-datadog-sampling-priority</em> HTTP header is used by the Datadog tracer in Envoy.
The integer value indicates the sampling decision that has been made for this trace.
A value of 0 indicates that the trace should not be collected, and a value of 1
requests that spans are sampled and reported.</p>
</div>
<div class="section" id="custom-request-response-headers">
<span id="config-http-conn-man-headers-custom-request-headers"></span><h2><a class="toc-backref" href="#id24">Custom request/response headers</a><a class="headerlink" href="#custom-request-response-headers" title="Permalink to this headline">¶</a></h2>
<p>Custom request/response headers can be added to a request/response at the weighted cluster,
route, virtual host, and/or global route configuration level. See the
<a class="reference internal" href="../../../api-v3/config/route/v3/route.proto.html#envoy-v3-api-msg-config-route-v3-routeconfiguration"><span class="std std-ref">v3</span></a> API documentation.</p>
<p>No <em>:-prefixed</em> pseudo-header may be modified via this mechanism. The <em>:path</em>
and <em>:authority</em> headers may instead be modified via mechanisms such as
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-prefix-rewrite"><span class="std std-ref">prefix_rewrite</span></a>,
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-regex-rewrite"><span class="std std-ref">regex_rewrite</span></a>, and
<a class="reference internal" href="../../../api-v3/config/route/v3/route_components.proto.html#envoy-v3-api-field-config-route-v3-routeaction-host-rewrite-literal"><span class="std std-ref">host_rewrite</span></a>.</p>
<p>Headers are appended to requests/responses in the following order: weighted cluster level headers,
route level headers, virtual host level headers and finally global level headers.</p>
<p>Envoy supports adding dynamic values to request and response headers. The percent symbol (%) is
used to delimit variable names.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>If a literal percent symbol (%) is desired in a request/response header, it must be escaped by
doubling it. For example, to emit a header with the value <code class="docutils literal notranslate"><span class="pre">100%</span></code>, the custom header value in
the Envoy configuration must be <code class="docutils literal notranslate"><span class="pre">100%%</span></code>.</p>
</div>
<p>Supported variable names are:</p>
<dl>
<dt>%DOWNSTREAM_REMOTE_ADDRESS%</dt><dd><p>Remote address of the downstream connection. If the address is an IP address it includes both
address and port.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This may not be the physical remote address of the peer if the address has been inferred from
<a class="reference internal" href="../../../api-v3/config/listener/v3/listener_components.proto.html#envoy-v3-api-field-config-listener-v3-filterchain-use-proxy-proto"><span class="std std-ref">proxy proto</span></a> or <a class="reference internal" href="#config-http-conn-man-headers-x-forwarded-for"><span class="std std-ref">x-forwarded-for</span></a>.</p>
</div>
</dd>
<dt>%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%</dt><dd><p>Same as <strong>%DOWNSTREAM_REMOTE_ADDRESS%</strong> excluding port if the address is an IP address.</p>
</dd>
<dt>%DOWNSTREAM_LOCAL_ADDRESS%</dt><dd><p>Local address of the downstream connection. If the address is an IP address it includes both
address and port.
If the original connection was redirected by iptables REDIRECT, this represents
the original destination address restored by the
<a class="reference internal" href="../../listeners/listener_filters/original_dst_filter.html#config-listener-filters-original-dst"><span class="std std-ref">Original Destination Filter</span></a> using SO_ORIGINAL_DST socket option.
If the original connection was redirected by iptables TPROXY, and the listener’s transparent
option was set to true, this represents the original destination address and port.</p>
</dd>
<dt>%DOWNSTREAM_LOCAL_ADDRESS_WITHOUT_PORT%</dt><dd><p>Same as <strong>%DOWNSTREAM_LOCAL_ADDRESS%</strong> excluding port if the address is an IP address.</p>
</dd>
<dt>%DOWNSTREAM_LOCAL_PORT%</dt><dd><p>Similar to <strong>%DOWNSTREAM_LOCAL_ADDRESS_WITHOUT_PORT%</strong>, but only extracts the port portion of the <strong>%DOWNSTREAM_LOCAL_ADDRESS%</strong></p>
</dd>
<dt>%DOWNSTREAM_LOCAL_URI_SAN%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The URIs present in the SAN of the local certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The URIs present in the SAN of the local certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_URI_SAN%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The URIs present in the SAN of the peer certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The URIs present in the SAN of the peer certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_LOCAL_SUBJECT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The subject present in the local certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The subject present in the local certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_SUBJECT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The subject present in the peer certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The subject present in the peer certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_ISSUER%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The issuer present in the peer certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The issuer present in the peer certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_SESSION_ID%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The session ID for the established downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The session ID for the established downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_CIPHER%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The OpenSSL name for the set of ciphers used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The OpenSSL name for the set of ciphers used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_TLS_VERSION%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The TLS version (e.g., <code class="docutils literal notranslate"><span class="pre">TLSv1.2</span></code>, <code class="docutils literal notranslate"><span class="pre">TLSv1.3</span></code>) used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The TLS version (e.g., <code class="docutils literal notranslate"><span class="pre">TLSv1.2</span></code>, <code class="docutils literal notranslate"><span class="pre">TLSv1.3</span></code>) used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_FINGERPRINT_256%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The hex-encoded SHA256 fingerprint of the client certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The hex-encoded SHA256 fingerprint of the client certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_FINGERPRINT_1%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The hex-encoded SHA1 fingerprint of the client certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The hex-encoded SHA1 fingerprint of the client certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_SERIAL%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The serial number of the client certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The serial number of the client certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The client certificate in the URL-encoded PEM format used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The client certificate in the URL-encoded PEM format used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT_V_START%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The validity start date of the client certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The validity start date of the client certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%DOWNSTREAM_PEER_CERT_V_END%</dt><dd><dl class="simple">
<dt>HTTP</dt><dd><p>The validity end date of the client certificate used to establish the downstream TLS connection.</p>
</dd>
<dt>TCP</dt><dd><p>The validity end date of the client certificate used to establish the downstream TLS connection.</p>
</dd>
</dl>
</dd>
<dt>%HOSTNAME%</dt><dd><p>The system hostname.</p>
</dd>
<dt>%PROTOCOL%</dt><dd><p>The original protocol which is already added by Envoy as a
<a class="reference internal" href="#config-http-conn-man-headers-x-forwarded-proto"><span class="std std-ref">x-forwarded-proto</span></a> request header.</p>
</dd>
<dt>%UPSTREAM_METADATA([“namespace”, “key”, …])%</dt><dd><p>Populates the header with <a class="reference internal" href="../../../api-v3/config/endpoint/v3/endpoint_components.proto.html#envoy-v3-api-field-config-endpoint-v3-lbendpoint-metadata"><span class="std std-ref">EDS endpoint metadata</span></a> from the
upstream host selected by the router. Metadata may be selected from any namespace. In general,
metadata values may be strings, numbers, booleans, lists, nested structures, or null. Upstream
metadata values may be selected from nested structs by specifying multiple keys. Otherwise,
only string, boolean, and numeric values are supported. If the namespace or key(s) are not
found, or if the selected value is not a supported type, then no header is emitted. The
namespace and key(s) are specified as a JSON array of strings. Finally, percent symbols in the
parameters <strong>do not</strong> need to be escaped by doubling them.</p>
<p>Upstream metadata cannot be added to request headers as the upstream host has not been selected
when custom request headers are generated.</p>
</dd>
<dt>%DYNAMIC_METADATA([“namespace”, “key”, …])%</dt><dd><p>Similar to UPSTREAM_METADATA, populates the header with dynamic metadata available in a request
(e.g.: added by filters like the header-to-metadata filter).</p>
<p>This works both on request and response headers.</p>
</dd>
<dt>%UPSTREAM_REMOTE_ADDRESS%</dt><dd><p>Remote address of the upstream host. If the address is an IP address it includes both address
and port. The upstream remote address cannot be added to request headers as the upstream host
has not been selected when custom request headers are generated.</p>
</dd>
<dt>%PER_REQUEST_STATE(reverse.dns.data.name)%</dt><dd><p>Populates the header with values set on the stream info filterState() object. To be
usable in custom request/response headers, these values must be of type
Envoy::Router::StringAccessor. These values should be named in standard reverse DNS style,
identifying the organization that created the value and ending in a unique name for the data.</p>
</dd>
<dt>%REQ(header-name)%</dt><dd><p>Populates the header with a value of the request header.</p>
</dd>
<dt>%START_TIME%</dt><dd><p>Request start time. START_TIME can be customized with specifiers as specified in
<a class="reference internal" href="../../observability/access_log/usage.html#config-access-log-format-start-time"><span class="std std-ref">access log format rules</span></a>.</p>
<p>An example of setting a custom header with current time in seconds with the milliseconds resolution:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>route:
  cluster: www
request_headers_to_add:
  - header:
      key: &quot;x-request-start&quot;
      value: &quot;%START_TIME(%s.%3f)%&quot;
    append: true
</pre></div>
</div>
</dd>
<dt>%RESPONSE_FLAGS%</dt><dd><p>Additional details about the response or connection, if any. Possible values and their meanings
are listed in the access log formatter <a class="reference internal" href="../../observability/access_log/usage.html#config-access-log-format-response-flags"><span class="std std-ref">documentation</span></a>.</p>
</dd>
<dt>%RESPONSE_CODE_DETAILS%</dt><dd><p>Response code details provides additional information about the HTTP response code, such as
who set it (the upstream or envoy) and why.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="header_sanitizing.html" class="btn btn-neutral float-right" title="HTTP header sanitizing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="header_casing.html" class="btn btn-neutral float-left" title="HTTP/1.1 Header Casing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>