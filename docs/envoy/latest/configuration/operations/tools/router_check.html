

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Route table check tool &mdash; envoy 1.17.0-dev-91f2bb documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Other features" href="../../other_features/other_features.html" />
    <link rel="prev" title="Overload manager" href="../overload_manager/overload_manager.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.17.0-dev-91f2bb
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../listeners/listeners.html">Listeners</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../operations.html">Operations</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overload_manager/overload_manager.html">Overload manager</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Route table check tool</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#coverage">Coverage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../operations.html">Operations</a> &raquo;</li>
        
      <li>Route table check tool</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/configuration/operations/tools/router_check.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="route-table-check-tool">
<span id="config-tools-router-check-tool"></span><h1>Route table check tool<a class="headerlink" href="#route-table-check-tool" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following configuration is for the route table check tool only and is not part of the Envoy binary.
The route table check tool is a standalone binary that can be used to verify Envoy’s routing for a given configuration
file.</p>
</div>
<p>The following specifies input to the route table check tool. The route table check tool checks if
the route returned by a <a class="reference internal" href="../../../api-v3/config/route/v3/route.proto.html#envoy-v3-api-msg-config-route-v3-routeconfiguration"><span class="std std-ref">router</span></a> matches what is expected.
The tool can be used to check cluster name, virtual cluster name,
virtual host name, manual path rewrite, manual host rewrite, path redirect, and
header field matches. Extensions for other test cases can be added. Details about installing the tool
and sample tool input/output can be found at <a class="reference internal" href="../../../start/install/tools/route_table_check_tool.html#install-tools-route-table-check-tool"><span class="std std-ref">installation</span></a>.</p>
<p>The route table check tool config is composed of an array of json test objects. Each test object is composed of
three parts.</p>
<dl class="simple">
<dt>Test name</dt><dd><p>This field specifies the name of each test object.</p>
</dd>
<dt>Input values</dt><dd><p>The input value fields specify the parameters to be passed to the router. Example input fields include
the :authority, :path, and :method header fields. The :authority and :path fields specify the url
sent to the router and are required. All other input fields are optional.</p>
</dd>
<dt>Validate</dt><dd><p>The validate fields specify the expected values and test cases to check. At least one test
case is required.</p>
</dd>
</dl>
<p>A simple tool configuration json has one test case and is written as follows. The test
expects a cluster name match of “instant-server”.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span>
<span class="o">-</span> <span class="n">test_name</span><span class="p">:</span> <span class="n">Cluster_name_test</span><span class="p">,</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">authority</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">lyft</span><span class="o">.</span><span class="n">com</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">locations</span>
  <span class="n">validate</span><span class="p">:</span>
    <span class="n">cluster_name</span><span class="p">:</span> <span class="n">instant</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">tests</span>
<span class="l l-Scalar l-Scalar-Plain">- test_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
  <span class="l l-Scalar l-Scalar-Plain">input</span><span class="p p-Indicator">:</span>
    <span class="nt">authority</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">method</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">internal</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">random_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">ssl</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">runtime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">additional_request_headers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
    <span class="nt">additional_response_headers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
<span class=" -Error">  </span><span class="nt">validate</span><span class="p">:</span>
    <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">virtual_cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">virtual_host_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">host_rewrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">path_rewrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">path_redirect</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
    <span class="nt">request_header_matches</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
        <span class="nt">exact_match</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
    <span class="nt">response_header_matches</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
        <span class="nt">exact_match</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...,</span>
        <span class="nt">presence_match</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">...</span>
</pre></div>
</div>
<dl>
<dt>test_name</dt><dd><p><em>(required, string)</em> The name of a test object.</p>
</dd>
<dt>input</dt><dd><p><em>(required, object)</em> Input values sent to the router that determine the returned route.</p>
<dl>
<dt>authority</dt><dd><p><em>(required, string)</em> The url authority. This value along with the path parameter define
the url to be matched. An example authority value is “api.lyft.com”.</p>
</dd>
<dt>path</dt><dd><p><em>(required, string)</em> The url path. An example path value is “/foo”.</p>
</dd>
<dt>method</dt><dd><p><em>(required, string)</em> The request method. If not specified, the default method is GET. The options
are GET, PUT, or POST.</p>
</dd>
<dt>internal</dt><dd><p><em>(optional, boolean)</em> A flag that determines whether to set x-envoy-internal to “true”.
If not specified, or if internal is equal to false, x-envoy-internal is not set.</p>
</dd>
<dt>random_value</dt><dd><p><em>(optional, integer)</em> An integer used to identify the target for weighted cluster selection
and as a factor for the routing engine to decide whether a runtime based route takes effect.
The default value of random_value is 0. For routes with runtime fraction numerators of 0,
the route checker tool changes the numerators to 1 so they can be tested with random_value
set to 0 to simulate the route being enabled and random_value set to any int &gt;= 1 to
simulate the route being disabled.</p>
</dd>
<dt>ssl</dt><dd><p><em>(optional, boolean)</em> A flag that determines whether to set x-forwarded-proto to https or http.
By setting x-forwarded-proto to a given protocol, the tool is able to simulate the behavior of
a client issuing a request via http or https. By default ssl is false which corresponds to
x-forwarded-proto set to http.</p>
</dd>
<dt>runtime</dt><dd><p><em>(optional, string)</em> A string representing the runtime setting to enable for the test. The runtime
setting along with the random_value is used by the router to decide if the route should be enabled.
Only a random_value lesser than the fractional percentage defined on the route entry enables the
route.</p>
</dd>
<dt>additional_request_headers, additional_response_headers</dt><dd><p><em>(optional, array)</em>  Additional headers to be added as input for route determination. The “authority”,
“path”, “method”, “x-forwarded-proto”, and “x-envoy-internal” fields are specified by the other config
options and should not be set here.</p>
<dl class="simple">
<dt>key</dt><dd><p><em>(required, string)</em> The name of the header field to add.</p>
</dd>
<dt>value</dt><dd><p><em>(required, string)</em> The value of the header field to add.</p>
</dd>
</dl>
</dd>
</dl>
</dd>
<dt>validate</dt><dd><p><em>(required, object)</em> The validate object specifies the returned route parameters to match. At least one
test parameter must be specified. Use “” (empty string) to indicate that no return value is expected.
For example, to test that no cluster match is expected use {“cluster_name”: “”}.</p>
<dl>
<dt>cluster_name</dt><dd><p><em>(optional, string)</em> Match the cluster name.</p>
</dd>
<dt>virtual_cluster_name</dt><dd><p><em>(optional, string)</em> Match the virtual cluster name.</p>
</dd>
<dt>virtual_host_name</dt><dd><p><em>(optional, string)</em> Match the virtual host name.</p>
</dd>
<dt>host_rewrite</dt><dd><p><em>(optional, string)</em> Match the host header field after rewrite.</p>
</dd>
<dt>path_rewrite</dt><dd><p><em>(optional, string)</em> Match the path header field after rewrite.</p>
</dd>
<dt>path_redirect</dt><dd><p><em>(optional, string)</em> Match the returned redirect path.</p>
</dd>
<dt>request_header_fields, response_header_fields</dt><dd><p><em>(optional, array, deprecated)</em>  Match the listed header fields. Example header fields include the “path”, “cookie”,
and “date” fields. The header fields are checked after all other test cases. Thus, the header fields checked
will be those of the redirected or rewritten routes when applicable.
These fields are deprecated. Use request_header_matches, response_header_matches instead.</p>
<dl class="simple">
<dt>key</dt><dd><p><em>(required, string)</em> The name of the header field to match.</p>
</dd>
<dt>value</dt><dd><p><em>(required, string)</em> The value of the header field to match.</p>
</dd>
</dl>
</dd>
<dt>request_header_matches, response_header_matches</dt><dd><p><em>(optional, array)</em>  Matchers for the listed headers. Example header fields include the “path”, “cookie”,
and “date” fields, as well as custom headers set in the input or by the route. The header fields are checked
after all other test cases. Thus, the header fields checked will be those of the redirected or rewritten
routes when applicable.
- Matchers are specified as <a class="reference internal" href="../../../api-v2/api/v2/route/route_components.proto.html#envoy-api-msg-route-headermatcher"><span class="std std-ref">HeaderMatchers</span></a>, and behave the same way.</p>
</dd>
</dl>
</dd>
</dl>
<div class="section" id="coverage">
<h2>Coverage<a class="headerlink" href="#coverage" title="Permalink to this headline">¶</a></h2>
<p>The router check tool will report route coverage at the end of a successful test run.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; bazel-bin/test/tools/router_check/router_check_tool --config-path ... --test-path ...
Current route coverage: <span class="m">0</span>.0744863
</pre></div>
</div>
<p>This reporting can be leveraged to enforce a minimum coverage percentage by using
the <cite>-f</cite> or <cite>–fail-under</cite> flag. If coverage falls below this percentage the test
run will fail.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; bazel-bin/test/tools/router_check/router_check_tool --config-path ... --test-path ... --fail-under <span class="m">8</span>
Current route coverage: <span class="m">7</span>.44863%
Failed to meet coverage requirement: <span class="m">8</span>%
</pre></div>
</div>
<p>By default the coverage report measures test coverage by checking that at least one field is
verified for every route. However, this can leave holes in the tests where fields
aren’t validated and later changed. For more comprehensive coverage you can add a flag,
<cite>–covall</cite>, which will calculate coverage taking into account all of the possible
fields that could be tested.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt; bazel-bin/test/tools/router_check/router_check_tool --config-path ... --test-path ... --f <span class="m">7</span> --covall
Current route coverage: <span class="m">6</span>.2948%
Failed to meet coverage requirement: <span class="m">7</span>%
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../other_features/other_features.html" class="btn btn-neutral float-right" title="Other features" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../overload_manager/overload_manager.html" class="btn btn-neutral float-left" title="Overload manager" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2016-2020, Envoy Project Authors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>