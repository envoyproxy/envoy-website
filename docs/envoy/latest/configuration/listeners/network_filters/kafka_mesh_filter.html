

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Kafka Mesh filter &mdash; envoy 1.20.0-dev-0bbf23 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/envoy.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Local rate limit" href="local_rate_limit_filter.html" />
    <link rel="prev" title="Kafka Broker filter" href="kafka_broker_filter.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/envoy-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.20.0-dev-0bbf23
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../about_docs.html">About the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../intro/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../start/start.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../configuration.html">Configuration reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../overview/overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../listeners.html">Listeners</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stats.html">Statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../runtime.html">Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../listener_filters/listener_filters.html">Listener filters</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="network_filters.html">Network filters</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="dubbo_proxy_filter.html">Dubbo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="client_ssl_auth_filter.html">Client TLS authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="connection_limit_filter.html">Connection Limit Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="echo_filter.html">Echo</a></li>
<li class="toctree-l4"><a class="reference internal" href="direct_response_filter.html">Direct response</a></li>
<li class="toctree-l4"><a class="reference internal" href="ext_authz_filter.html">External Authorization</a></li>
<li class="toctree-l4"><a class="reference internal" href="kafka_broker_filter.html">Kafka Broker filter</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Kafka Mesh filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="local_rate_limit_filter.html">Local rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="mongo_proxy_filter.html">Mongo proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="mysql_proxy_filter.html">MySQL proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="postgres_proxy_filter.html">Postgres proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rate_limit_filter.html">Rate limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="rbac_filter.html">Role Based Access Control (RBAC) Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="redis_proxy_filter.html">Redis proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="rocketmq_proxy_filter.html">RocketMQ proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="tcp_proxy_filter.html">TCP proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="thrift_proxy_filter.html">Thrift proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_cluster_filter.html">Upstream Cluster from SNI</a></li>
<li class="toctree-l4"><a class="reference internal" href="sni_dynamic_forward_proxy_filter.html">SNI dynamic forward proxy</a></li>
<li class="toctree-l4"><a class="reference internal" href="wasm_filter.html">Wasm Network Filter</a></li>
<li class="toctree-l4"><a class="reference internal" href="zookeeper_proxy_filter.html">ZooKeeper proxy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../udp_filters/udp_filters.html">UDP listener filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lds.html">Listener discovery service (LDS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../http/http.html">HTTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../upstream/upstream.html">Upstream clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../observability/observability.html">Observability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../security/security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../operations/operations.html">Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_features/other_features.html">Other features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../other_protocols/other_protocols.html">Other protocols</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../advanced/advanced.html">Advanced</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../best_practices/best_practices.html">Configuration best practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/operations.html">Operations and administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extending/extending.html">Extending Envoy for custom use cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/overview.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version_history/version_history.html">Version history</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">envoy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../configuration.html">Configuration reference</a> &raquo;</li>
        
          <li><a href="../listeners.html">Listeners</a> &raquo;</li>
        
          <li><a href="network_filters.html">Network filters</a> &raquo;</li>
        
      <li>Kafka Mesh filter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/configuration/listeners/network_filters/kafka_mesh_filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kafka-mesh-filter">
<span id="config-network-filters-kafka-mesh"></span><h1>Kafka Mesh filter<a class="headerlink" href="#kafka-mesh-filter" title="Permalink to this headline">¶</a></h1>
<p>The Apache Kafka mesh filter provides a facade for <a class="reference external" href="https://kafka.apache.org/">Apache Kafka</a>
producers. Produce requests sent to this filter insance can be forwarded to one of multiple
clusters, depending on configured forwarding rules. Corresponding message versions from
Kafka 2.4.0 are supported.</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../../api-v3/extensions/filters/network/kafka_mesh/v3alpha/kafka_mesh.proto.html#envoy-v3-api-msg-extensions-filters-network-kafka-mesh-v3alpha-kafkamesh"><span class="std std-ref">v3 API reference</span></a></p></li>
<li><p>This filter should be configured with the name <em>envoy.filters.network.kafka_mesh</em>.</p></li>
</ul>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The Kafka mesh filter is only included in <a class="reference internal" href="../../../start/install.html#install-contrib"><span class="std std-ref">contrib images</span></a></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The kafka_mesh filter is experimental and is currently under active development.
Capabilities will be expanded over time and the configuration structures are likely to change.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The kafka_mesh filter is does not work on Windows (the blocker is getting librdkafka compiled).</p>
</div>
<div class="section" id="configuration">
<span id="config-network-filters-kafka-mesh-config"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Below example shows us typical filter configuration that proxies 3 Kafka clusters.
Clients are going to connect to ‘127.0.0.1:19092’, and their messages are going to be distributed
to cluster depending on topic names.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">listeners</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">address</span><span class="p">:</span>
    <span class="nt">socket_address</span><span class="p">:</span>
      <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span> <span class="c1"># Host that Kafka clients should connect to.</span>
      <span class="nt">port_value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">19092</span>  <span class="c1"># Port that Kafka clients should connect to.</span>
  <span class="nt">filter_chains</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">envoy.filters.network.kafka_mesh</span>
      <span class="nt">typed_config</span><span class="p">:</span>
        <span class="s">&quot;@type&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">type.googleapis.com/envoy.extensions.filters.network.kafka_mesh.v3alpha.KafkaMesh</span>
        <span class="nt">advertised_host</span><span class="p">:</span> <span class="s">&quot;127.0.0.1&quot;</span>
        <span class="nt">advertised_port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">19092</span>
        <span class="nt">upstream_clusters</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c1</span>
          <span class="nt">bootstrap_servers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster1_node1:9092,cluster1_node2:9092,cluster1_node3:9092</span>
          <span class="nt">partition_count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="p p-Indicator">-</span> <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c2</span>
          <span class="nt">bootstrap_servers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster2_node1:9092,cluster2_node2:9092,cluster2_node3:9092</span>
          <span class="nt">partition_count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="p p-Indicator">-</span> <span class="nt">cluster_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c3</span>
          <span class="nt">bootstrap_servers</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster3_node1:9092,cluster3_node2:9092</span>
          <span class="nt">partition_count</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">producer_config</span><span class="p">:</span>
            <span class="nt">acks</span><span class="p">:</span> <span class="s">&quot;1&quot;</span>
            <span class="nt">linger.ms</span><span class="p">:</span> <span class="s">&quot;500&quot;</span>
        <span class="nt">forwarding_rules</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">target_cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c1</span>
          <span class="nt">topic_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apples</span>
        <span class="p p-Indicator">-</span> <span class="nt">target_cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c2</span>
          <span class="nt">topic_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bananas</span>
        <span class="p p-Indicator">-</span> <span class="nt">target_cluster</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kafka_c3</span>
          <span class="nt">topic_prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cherries</span>
</pre></div>
</div>
<p>It should be noted that Kafka broker filter can be inserted before Kafka mesh filter in the filter
chain to capture the request processing metrics.</p>
</div>
<div class="section" id="notes">
<span id="config-network-filters-kafka-mesh-notes"></span><h2>Notes<a class="headerlink" href="#notes" title="Permalink to this headline">¶</a></h2>
<p>Given that this filter does its own processing of received requests, there are some changes
in behaviour compared to explicit connection to a Kafka cluster:</p>
<ol class="arabic simple">
<li><p>Record headers are not sent upstream.</p></li>
<li><p>Only ProduceRequests with version 2 are supported (what means very old producers like 0.8 are
not going to be supported).</p></li>
<li><p>Python producers need to set API version of at least 1.0.0, so that the produce requests they
send are going to have records with magic equal to 2.</p></li>
<li><p>Downstream handling of Kafka producer ‘acks’ property is delegated to upstream client.
E.g. if upstream client is configured to use acks=0 then the response is going to be sent
to downstream client as soon as possible (even if they had non-zero acks!).</p></li>
<li><p>As the filter splits single producer requests into separate records, it’s possible that delivery
of only some of these records fails. In that case, the response returned to upstream client is
a failure, however it is possible some of the records have been appended in target cluster.</p></li>
<li><p>Because of the splitting mentioned above, records are not necessarily appended one after another
(as they do not get sent as single request to upstream). Users that want to avoid this scenario
might want to take a look into downstream producer configs: ‘linger.ms’ and ‘batch.size’.</p></li>
<li><p>Produce requests that reference to topics that do not match any of the rules are going to close
connection and fail. This usually should not happen (clients request metadata first, and they
should then fail with ‘no broker available’ first), but is possible if someone tailors binary
payloads over the connection.</p></li>
<li><p>librdkafka was compiled without ssl, lz4, gssapi, so related custom producer config options are
not supported.</p></li>
<li><p>Invalid custom producer configs are not found at startup (only when appropriate clusters are
being sent to). Requests that would have referenced these clusters are going to close connection
and fail.</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="local_rate_limit_filter.html" class="btn btn-neutral float-right" title="Local rate limit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="kafka_broker_filter.html" class="btn btn-neutral float-left" title="Kafka Broker filter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2016-2021, Envoy Project Authors.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>